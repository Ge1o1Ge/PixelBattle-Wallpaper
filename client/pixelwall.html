<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PixelBattle Mega Canvas</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				user-select: none;
				-webkit-user-select: none;
			}

			body {
				overflow: hidden;
				width: 100vw;
				height: 100vh;
				background: linear-gradient(45deg, #0a0a0a 0%, #1a1a1a 100%);
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				cursor: crosshair;
			}

			#mainCanvas {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				image-rendering: pixelated;
				image-rendering: crisp-edges;
			}

			.status-item {
				display: flex;
				align-items: center;
				gap: 6px;
				white-space: nowrap;
			}

			.status-dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				margin: 3px;
				transition: background-color 0.3s;
			}

			.connected .status-dot {
				background: #4caf50;
				box-shadow: 0 0 10px #4caf50;
			}
			.connecting .status-dot {
				background: #ff9800;
				box-shadow: 0 0 10px #ff9800;
				animation: pulse 1.5s infinite;
			}
			.disconnected .status-dot {
				background: #f44336;
				box-shadow: 0 0 10px #f44336;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			#cooldownTimer {
				color: #4caf50;
				font-weight: bold;
				font-size: 13px;
				min-width: 40px;
			}

			.status-label {
				opacity: 0.8;
				font-size: 11px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ */

			.palette-compact {
				display: flex;
				flex-direction: column;
				padding: 10px;
				gap: 6px;
			}

			.color-row {
				display: flex;
				gap: 6px;
			}

			.color-swatch {
				width: 32px;
				height: 32px;
				border-radius: 8px;
				cursor: pointer;
				border: 2px solid transparent;
				transition: all 0.2s ease;
				position: relative;
			}

			.color-swatch:hover {
				transform: scale(1.1);
				box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
			}

			.color-swatch.selected {
				border-color: white;
				transform: scale(1.1);
				box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
			}

			.color-swatch.selected::after {
				content: "‚úì";
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: white;
				font-size: 14px;
				font-weight: bold;
				text-shadow: 0 0 3px black;
			}

			/* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */

			.nav-item {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 4px;
				cursor: pointer;
				color: white;
				padding: 8px 12px;
				border-radius: 8px;
				transition: background 0.3s;
				min-width: 60px;
			}

			.nav-item:hover {
				background: rgba(255, 255, 255, 0.1);
			}

			.nav-item i {
				font-size: 20px;
				margin-bottom: 2px;
			}

			.nav-item span {
				font-size: 10px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				opacity: 0.8;
			}

			/* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑—É–º–µ */
			#zoomInfo {
				position: absolute;
				bottom: 20px;
				left: 20px;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 10px 15px;
				border-radius: 10px;
				font-size: 12px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 90;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			#zoomInfo:hover {
				opacity: 1;
			}

			.zoom-value {
				font-size: 14px;
				font-weight: bold;
				color: #4caf50;
				margin-left: 5px;
			}

			/* –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ */
			#minimap {
				position: absolute;
				top: 70px;
				right: 20px;
				width: 150px;
				height: 150px;
				background: rgba(0, 0, 0, 0.85);
				border-radius: 8px;
				backdrop-filter: blur(10px);
				border: 2px solid rgba(255, 255, 255, 0.2);
				z-index: 95;
				overflow: hidden;
				opacity: 0.5;
				transition: opacity 0.3s;
			}

			#minimap:hover {
				opacity: 1;
			}

			#minimapCanvas {
				width: 100%;
				height: 100%;
			}

			.minimap-viewport {
				position: absolute;
				border: 2px solid #4caf50;
				background: rgba(76, 175, 80, 0.1);
				pointer-events: none;
			}

			/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
			.notification {
				position: absolute;
				top: 70px;
				left: 20px;
				background: rgba(0, 0, 0, 0.9);
				color: white;
				padding: 15px 20px;
				border-radius: 10px;
				backdrop-filter: blur(10px);
				border-left: 4px solid #4caf50;
				z-index: 200;
				animation:
					slideInLeft 0.3s,
					fadeOut 0.3s 2.7s;
				max-width: 350px;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				pointer-events: none;
			}

			.notification.error {
				border-left-color: #f44336;
			}

			.notification.warning {
				border-left-color: #ff9800;
			}

			.notification.info {
				border-left-color: #2196f3;
			}

			@keyframes slideInLeft {
				from {
					transform: translateX(-100%);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}

			@keyframes fadeOut {
				to {
					opacity: 0;
				}
			}

			/* –õ–æ–∞–¥–µ—Ä */
			#loader {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				text-align: center;
				color: white;
				z-index: 1000;
				background: rgba(0, 0, 0, 0.9);
				padding: 30px 40px;
				border-radius: 15px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				min-width: 300px;
			}

			.spinner {
				border: 3px solid rgba(255, 255, 255, 0.1);
				border-top: 3px solid #4caf50;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
				margin: 0 auto 15px;
			}

			.progress-bar {
				width: 100%;
				height: 4px;
				background: rgba(255, 255, 255, 0.1);
				border-radius: 2px;
				margin: 15px 0;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				background: #4caf50;
				width: 0%;
				transition: width 0.3s;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			/* –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ */

			.tool-btn {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.85);
				border: 1px solid rgba(255, 255, 255, 0.15);
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				backdrop-filter: blur(10px);
				transition: all 0.3s;
				font-size: 18px;
				opacity: 0.7;
			}

			.tool-btn:hover {
				opacity: 1;
				transform: scale(1.1);
				background: rgba(0, 0, 0, 0.95);
			}

			.tool-btn.active {
				background: #4caf50;
				color: white;
				opacity: 1;
			}

			/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
			#coordIndicator {
				position: absolute;
				bottom: 80px;
				right: 20px;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 8px 12px;
				border-radius: 8px;
				font-size: 11px;
				font-family: monospace;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 90;
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			#coordIndicator:hover {
				opacity: 1;
			}

			/* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
			.hidden {
				display: none !important;
			}

			/* –°–µ—Ç–∫–∞ */
			.grid-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				opacity: 0.1;
				background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
				background-size: 20px 20px;
			}

			/* –õ—É–ø–∞ */
			/* –õ—É–ø–∞ - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
			#magnifierContainer {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				z-index: 150;
			}

			#magnifier {
				position: absolute;
				width: 200px;
				height: 200px;
				background: rgba(0, 0, 0, 0.95);
				border: 3px solid rgba(255, 255, 255, 0.3);
				box-shadow:
					0 0 0 1px rgba(0, 0, 0, 0.8),
					0 0 30px rgba(0, 0, 0, 0.6),
					0 0 0 2px rgba(255, 255, 255, 0.1) inset,
					0 0 20px rgba(0, 0, 0, 0.8);
				overflow: hidden;
				backdrop-filter: blur(1px);
				transform: translate(0, 0);
				display: block;
				border-radius: 4px;
			}

			#magnifierCanvas {
				width: 100%;
				height: 100%;
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				display: block;
			}

			#magnifierCrosshair {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
			}

			#magnifierInfo {
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 6px 8px;
				font-size: 10px;
				display: flex;
				justify-content: space-between;
				backdrop-filter: blur(5px);
				border-top: 1px solid rgba(255, 255, 255, 0.2);
				font-family: monospace;
			}

			#magnifierZoom {
				color: #4caf50;
				font-weight: bold;
			}

			#magnifierColor {
				font-weight: bold;
			}

			/* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ª—É–ø—ã */
			.tool-btn.magnifier-active {
				background: #2196f3;
				color: white;
				box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
				animation: pulse-magnifier 2s infinite;
			}

			@keyframes pulse-magnifier {
				0%,
				100% {
					box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
				}
				50% {
					box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
				}
			}

			/* ===== –ù–û–í–´–ï –°–¢–ò–õ–ò UI-–ü–ê–ù–ï–õ–ï–ô ===== */
			.ui-panel {
				position: absolute;
				background: rgba(0, 0, 0, 0.85);
				border-radius: 10px;
				border: 1px solid rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(10px);
				color: #fff;
				min-width: 160px;
				z-index: 200;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
			}

			.ui-panel-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 6px 10px;
				cursor: move;
				user-select: none;
				font-size: 12px;
				background: rgba(255, 255, 255, 0.05);
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 10px 10px 0 0;
			}

			.ui-panel-title {
				font-weight: 600;
				opacity: 0.9;
			}

			.ui-panel-controls {
				display: flex;
				gap: 4px;
			}

			.ui-panel-controls button {
				background: transparent;
				border: none;
				color: #fff;
				cursor: pointer;
				width: 18px;
				height: 18px;
				border-radius: 3px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 10px;
				opacity: 0.7;
				transition: opacity 0.2s;
			}

			.ui-panel-controls button:hover {
				opacity: 1;
				background: rgba(255, 255, 255, 0.1);
			}

			.ui-panel-body {
				padding: 8px;
				max-height: 400px;
				overflow-y: auto;
				width: fit-content;
			}

			.ui-panel.minimized .ui-panel-body {
				display: none;
			}

			.ui-panel.minimized {
				min-width: auto;
				width: auto;
			}

			/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞–Ω–µ–ª–∏ */
			#toolsPanel .ui-panel-body {
				display: flex;
				flex-direction: column;
				gap: 8px;
				padding: 10px;
			}

			#palettePanel .ui-panel-body {
				display: flex;
				flex-direction: column;
				gap: 6px;
				padding: 10px;
			}

			#statusPanel .ui-panel-body {
				padding: 12px;
			}

			.status-full {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}

			.status-compact {
				display: none;
				padding: 4px 8px;
				white-space: nowrap;
				min-width: 100px;
			}

			.ui-panel.minimized .status-full {
				display: none;
			}

			.ui-panel.minimized .status-compact {
				display: flex;
				align-items: center;
				gap: 6px;
			}

			/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ - –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
			#palettePanel.minimized .ui-panel-body,
			#toolsPanel.minimized .ui-panel-body {
				display: none;
			}
		</style>
	</head>
	<body>
		<canvas id="mainCanvas"></canvas>

		<!-- –°–µ—Ç–∫–∞ -->
		<div id="gridOverlay" class="grid-overlay hidden"></div>

		<!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
		<!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ -->
		<div class="ui-panel" id="statusPanel" data-panel="status" style="right: 20px; top: 20px">
			<div class="ui-panel-header">
				<span class="ui-panel-title">Status </span> <span class="status-dot"></span>
				<div class="ui-panel-controls">
					<button class="btn-minimize">‚Äì</button>
				</div>
			</div>

			<div class="ui-panel-body">
				<!-- –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
				<div class="status-full">
					<div class="status-item">
						<span class="status-dot"></span>
						<div>
							<div class="status-label">Status</div>
							<div id="statusText">Connected</div>
						</div>
					</div>
					<div class="status-item">
						<div>
							<div class="status-label">Cooldown</div>
							<div id="cooldownTimer">Ready</div>
						</div>
					</div>
					<div class="status-item">
						<div>
							<div class="status-label">Online</div>
							<div id="onlineCount">0</div>
						</div>
					</div>
					<div class="status-item">
						<div>
							<div class="status-label">FPS</div>
							<div id="fpsCounter">60</div>
						</div>
					</div>
					<div class="status-item">
						<div>
							<div class="status-label">Reconnect</div>
							<button id="btnReconnect" style="background: #2196f3; border: none; color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 2px">Retry</button>
						</div>
					</div>
				</div>

				<!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å–≤–µ—Ä–Ω—É—Ç–æ) -->
				<div class="status-compact">
					<span class="status-dot"></span>
					<span id="statusCompactText">Online</span>
				</div>
			</div>
		</div>

		<!-- –ü–∞–Ω–µ–ª—å –ø–∞–ª–∏—Ç—Ä—ã -->
		<div class="ui-panel" id="palettePanel" data-panel="palette" style="right: 20px; top: 120px">
			<div class="ui-panel-header">
				<span class="ui-panel-title">Palette</span>
				<div class="ui-panel-controls">
					<button class="btn-minimize">‚Äì</button>
				</div>
			</div>
			<div class="ui-panel-body" id="paletteContainer">
				<!-- –¶–≤–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
			</div>
		</div>

		<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑—É–º–µ -->
		<div id="zoomInfo">Zoom: <span id="zoomValue" class="zoom-value">100%</span></div>

		<!-- –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ -->
		<div id="minimap" class="hidden">
			<canvas id="minimapCanvas"></canvas>
			<div id="minimapViewport" class="minimap-viewport"></div>
		</div>

		<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
		<div id="coordIndicator">X: <span id="coordX">0</span>, Y: <span id="coordY">0</span></div>

		<!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
		<div class="ui-panel" id="toolsPanel" data-panel="tools" style="left: 20px; top: 100px">
			<div class="ui-panel-header">
				<span class="ui-panel-title">Tools</span>
				<div class="ui-panel-controls">
					<button class="btn-minimize">‚Äì</button>
				</div>
			</div>
			<div class="ui-panel-body">
				<div class="tool-btn" id="toolHand" title="Pan Tool (H)">‚úã</div>
				<div class="tool-btn active" id="toolPencil" title="Pencil Tool (P)">‚úèÔ∏è</div>
				<div class="tool-btn" id="toolPicker" title="Color Picker (C)">üé®</div>
				<div class="tool-btn" id="toolMagnifier" title="Magnifier Tool (M)">üîç</div>
				<div class="tool-btn" id="navZoomOut" title="Zoom Out"><i>üîç‚àí</i></div>
				<div class="tool-btn" id="navZoomIn" title="Zoom In"><i>üîç+</i></div>
				<div class="tool-btn" id="navCenter" title="Center View"><i>‚óé</i></div>
				<!-- <div class="tool-btn" id="navGrid" title="Toggle Grid"><i>#</i></div> -->
				<div class="tool-btn" id="navMinimap" title="Toggle Minimap"><i>üó∫Ô∏è</i></div>
			</div>
		</div>

		<!-- –õ–æ–∞–¥–µ—Ä -->
		<div id="loader">
			<div class="spinner"></div>
			<div id="loaderTitle">Connecting to PixelBattle...</div>
			<div class="progress-bar">
				<div class="progress-fill" id="loaderProgress"></div>
			</div>
			<div id="loaderStatus" style="font-size: 12px; opacity: 0.8">Loading canvas data...</div>
		</div>

		<!-- –õ—É–ø–∞ -->
		<div id="magnifierContainer" class="hidden">
			<div id="magnifier">
				<canvas id="magnifierCanvas"></canvas>
				<div id="magnifierInfo">
					<div>Zoom: <span id="magnifierZoom">4x</span></div>
					<div>Color: <span id="magnifierColor">#000</span></div>
				</div>
			</div>
		</div>

		<script>
			const PIXEL_SIZE = 1; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∏–∫—Å–µ–ª—è

			// ===== UI MANAGER =====
			const UIManager = {
				panels: new Map(),
				dragState: null,

				init() {
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
					document.querySelectorAll(".ui-panel").forEach(panel => {
						// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º right/bottom –≤ left/top –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
						const rect = panel.getBoundingClientRect();
						if (panel.style.right && !panel.style.left) {
							panel.style.left = `${rect.left}px`;
							panel.style.right = "auto";
						}
						if (panel.style.bottom && !panel.style.top) {
							panel.style.top = `${rect.top}px`;
							panel.style.bottom = "auto";
						}

						this.makeDraggable(panel);
						this.makeMinimizable(panel);
						this.restoreState(panel);

						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä–Ω—É—Ç–∞
						if (panel.classList.contains("minimized")) {
							const btn = panel.querySelector(".btn-minimize");
							if (btn) btn.textContent = "+";
						}
					});

					// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
					this.initHotkeys();
				},

				makeMinimizable(panel) {
					const btn = panel.querySelector(".btn-minimize");
					if (!btn) return;

					btn.addEventListener("click", e => {
						e.stopPropagation();
						panel.classList.toggle("minimized");

						// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–∫–æ–Ω–∫—É –º–µ–∂–¥—É "-" –∏ "+"
						btn.textContent = panel.classList.contains("minimized") ? "+" : "‚Äì";

						this.saveState(panel);

						// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
						if (panel.id === "statusPanel") {
							const statusText = panel.querySelector("#statusText").textContent;
							panel.querySelector("#statusCompactText").textContent = statusText;
						}
					});
				},

				makeDraggable(panel) {
					const header = panel.querySelector(".ui-panel-header");
					if (!header) return;

					header.addEventListener("mousedown", e => {
						if (e.target.closest(".ui-panel-controls")) return;

						// Clear right positioning and convert to left positioning
						const rect = panel.getBoundingClientRect();
						const left = rect.left;
						const top = rect.top;

						// Remove right/bottom properties to avoid conflicts
						panel.style.right = "auto";
						panel.style.bottom = "auto";
						panel.style.left = `${left}px`;
						panel.style.top = `${top}px`;

						this.dragState = {
							panel,
							startX: e.clientX,
							startY: e.clientY,
							startLeft: left,
							startTop: top
						};

						// –ü–æ–¥–Ω–∏–º–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞–≤–µ—Ä—Ö
						document.querySelectorAll(".ui-panel").forEach(p => {
							p.style.zIndex = "200";
						});
						panel.style.zIndex = "300";
					});

					// –≠—Ç–∏ —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ document –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ dragging –¥–∞–∂–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –ø–∞–Ω–µ–ª–∏
					const moveHandler = e => {
						if (!this.dragState) return;

						const dx = e.clientX - this.dragState.startX;
						const dy = e.clientY - this.dragState.startY;

						this.dragState.panel.style.left = `${this.dragState.startLeft + dx}px`;
						this.dragState.panel.style.top = `${this.dragState.startTop + dy}px`;
					};

					const upHandler = () => {
						if (this.dragState) {
							this.saveState(this.dragState.panel);
							this.dragState = null;
						}
					};

					// –ò—Å–ø–æ–ª—å–∑—É–µ–º capture —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
					document.addEventListener("mousemove", moveHandler);
					document.addEventListener("mouseup", upHandler);

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
					panel._dragHandlers = { move: moveHandler, up: upHandler };
				},

				saveState(panel) {
					const id = panel.dataset.panel;
					const state = {
						x: panel.offsetLeft,
						y: panel.offsetTop,
						minimized: panel.classList.contains("minimized")
					};
					localStorage.setItem(`ui:${id}`, JSON.stringify(state));
				},

				restoreState(panel) {
					const id = panel.dataset.panel;
					const data = localStorage.getItem(`ui:${id}`);
					if (!data) return;

					try {
						const state = JSON.parse(data);
						if (state.x !== undefined) {
							panel.style.right = "auto";
							panel.style.left = `${state.x}px`;
						}
						if (state.y !== undefined) {
							panel.style.bottom = "auto";
							panel.style.top = `${state.y}px`;
						}
						if (state.minimized) panel.classList.add("minimized");
					} catch (e) {
						console.warn("Failed to restore UI state:", e);
					}
				},

				initHotkeys() {
					document.addEventListener("keydown", e => {
						// H - —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ UI –ø–∞–Ω–µ–ª–∏
						if (e.key.toLowerCase() === "h" && !e.ctrlKey && !e.altKey && !e.metaKey) {
							e.preventDefault();
							const panels = document.querySelectorAll(".ui-panel");
							const allHidden = Array.from(panels).every(p => p.style.display === "none");

							panels.forEach(panel => {
								panel.style.display = allHidden ? "" : "none";
							});

							const message = allHidden ? "UI shown (H)" : "UI hidden (H)";
							if (window.pixelWall) window.pixelWall.showNotification(message, "info");
						}

						// F1 - —Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ UI
						if (e.key === "F1") {
							e.preventDefault();
							document.querySelectorAll(".ui-panel").forEach(panel => {
								localStorage.removeItem(`ui:${panel.dataset.panel}`);
								panel.style.left = "";
								panel.style.top = "";
								panel.classList.remove("minimized");
							});
							if (window.pixelWall) window.pixelWall.showNotification("UI positions reset", "info");
						}
					});
				}
			};

			class PixelBattleWallpaper {
				constructor() {
					this.canvasBuffer = null; // –ë—É—Ñ–µ—Ä –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
					this.bufferCtx = null;
					this.isRendering = false;
					this.dirtyRect = null; // –û–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
					this.loadedPixels = 0;
					this.totalPixels = 0;

					this.canvas = document.getElementById("mainCanvas");
					this.ctx = this.canvas.getContext("2d");
					this.ws = null;

					// –ê–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
					this.reconnectAttempts = 0;
					this.maxReconnectAttempts = 10;
					this.reconnectDelay = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
					this.maxReconnectDelay = 30000; // 30 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
					this.reconnectTimeout = null;

					// –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –¥–æ–±–∞–≤–ª—è–µ–º:
					this.pendingBinaryData = null;
					this.expectingBinaryData = false;

					// –ë—É—Ñ–µ—Ä –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
					this.canvasBuffer = null;
					this.bufferCtx = null;

					// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
					this.canvasWidth = 800; // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
					this.canvasHeight = 800;
					this.cooldownTime = 1000; // 30 —Å–µ–∫—É–Ω–¥

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—ã
					this.camera = {
						x: 0,
						y: 0,
						zoom: 1.0,
						minZoom: 0.1,
						maxZoom: 20
					};

					// –õ—É–ø–∞
					this.magnifier = {
						enabled: false, // —Ç–æ–≥–ª –≤–∫–ª/–≤—ã–∫–ª
						zoomFactor: 4, // –º–Ω–æ–∂–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û —Ç–µ–∫—É—â–µ–≥–æ –∑—É–º–∞
						size: 200, // —Ä–∞–∑–º–µ—Ä –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–π –ª—É–ø—ã
						offsetX: 20, // —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
						offsetY: 20,
						canvas: null,
						ctx: null,
						canvasElement: null,
						showPixelGrid: true,
						showCrosshair: true
					};

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
					this.selectedColor = 0;
					this.activeTool = "pencil"; // pencil, hand, picker, fill
					this.isDragging = false;
					this.dragStart = { x: 0, y: 0 };
					this.showGrid = false;
					this.showMinimap = true;

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ
					// –ò—Å–ø–æ–ª—å–∑—É–µ–º Uint8Array –≤–º–µ—Å—Ç–æ Map –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (1 –±–∞–π—Ç –Ω–∞ –ø–∏–∫—Å–µ–ª—å)
					this.pixels = null; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ initCanvasBuffer
					this.imageData = null; // ImageData –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
					this.selectedColor = 0;
					this.activeTool = "pencil";
					this.isDragging = false;
					this.dragStart = { x: 0, y: 0 };
					this.isConnected = false;
					this.lastClickTime = 0;
					this.cooldownTime = 1000;

					// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
					this.lastFrameTime = 0;
					this.fps = 60;
					this.frameCount = 0;
					this.lastFpsUpdate = 0;
					this.loadedChunkCount = 0; // –°—á–µ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤

					// –ê–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
					this.reconnectAttempts = 0;
					this.maxReconnectAttempts = 10;
					this.reconnectDelay = 2000; // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã
					this.maxReconnectDelay = 30000; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 30 —Å–µ–∫—É–Ω–¥
					this.reconnectTimeout = null;
					this.quietReconnect = false; // —Ñ–ª–∞–≥ –¥–ª—è —Ç–∏—Ö–æ–≥–æ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ (–±–µ–∑ –ª–æ–∞–¥–µ—Ä–∞)
					this.isReconnecting = false;

					// –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:
					this.pingInterval = null;
					this.lastPongTime = 0;
					this.pingTimeout = 30000; // 30 —Å–µ–∫—É–Ω–¥

					// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
					this.serverConfig = {
						host: window.location.hostname || "localhost",
						port: 8080,
						secure: false,
						path: "/ws"
					};

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
					this.init();
				}

				init() {
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–æ–ª—Å—Ç–∞
					this.resizeCanvas();
					window.addEventListener("resize", () => this.resizeCanvas());

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
					this.initPalette();
					this.initMinimap();
					this.initEventListeners();
					this.initTools();

					// –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä
					this.updateLoader("Connecting to server...", 0);

					// –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
					this.connectToServer();

					this.initMagnifier();
					UIManager.init();

					// –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
					this.animate();
				}

				initPalette() {
					const paletteContainer = document.getElementById("paletteContainer");
					const colors = this.getColorPalette();

					// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –ø–æ 8 –≤ —Ä—è–¥
					for (let i = 0; i < colors.length; i += 8) {
						const row = document.createElement("div");
						row.className = "color-row";

						for (let j = 0; j < 8; j++) {
							const index = i + j;
							if (index >= colors.length) break;

							const swatch = document.createElement("div");
							swatch.className = "color-swatch";
							if (index === this.selectedColor) {
								swatch.classList.add("selected");
							}
							swatch.style.backgroundColor = colors[index];
							swatch.dataset.index = index;

							swatch.addEventListener("click", e => {
								this.selectedColor = parseInt(e.target.dataset.index);
								document.querySelectorAll(".color-swatch").forEach(s => {
									s.classList.remove("selected");
								});
								e.target.classList.add("selected");
								this.activeTool = "pencil";
								this.updateTools();
							});

							row.appendChild(swatch);
						}
						paletteContainer.appendChild(row);
					}
				}

				initMagnifier() {
					this.magnifier.canvasElement = document.getElementById("magnifierCanvas");
					this.magnifier.canvas = document.createElement("canvas");
					this.magnifier.canvas.width = this.magnifier.size;
					this.magnifier.canvas.height = this.magnifier.size;
					this.magnifier.ctx = this.magnifier.canvas.getContext("2d");

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
					this.magnifier.ctx.imageSmoothingEnabled = false;

					// –í–∞–∂–Ω–æ: –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ª—É–ø—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ initTools()
					// (–∏–Ω–∞—á–µ –±—É–¥–µ—Ç –¥–≤–æ–π–Ω–æ–π toggle –∏ –ª—É–ø–∞ "–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è")

					// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ª—É–ø—ã (—á—Ç–æ–±—ã –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –¥–∞–∂–µ –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã canvas)
					document.addEventListener("mousemove", e => {
						if (!this.magnifier.enabled) return;

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ canvas
						const rect = this.canvas.getBoundingClientRect();
						const mouseX = e.clientX;
						const mouseY = e.clientY;
						
						const isOverCanvas = mouseX >= rect.left && mouseX <= rect.right && 
						                      mouseY >= rect.top && mouseY <= rect.bottom;
						
						// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ UI –ø–∞–Ω–µ–ª—è–º–∏
						const isOverUI = e.target.closest(".ui-panel") !== null;
						
						if (isOverCanvas && !isOverUI) {
							// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É–ø—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
							document.getElementById("magnifierContainer").classList.remove("hidden");
							this.updateMagnifierPosition(e);
						} else {
							// –°–∫—Ä—ã–≤–∞–µ–º –ª—É–ø—É –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ canvas –∏–ª–∏ –Ω–∞–¥ UI
							document.getElementById("magnifierContainer").classList.add("hidden");
						}
					});

					// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑—É–º–∞ –ª—É–ø—ã –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏ –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–º Alt
					this.canvas.addEventListener("wheel", e => {
						if (e.altKey && this.magnifier.enabled) {
							e.preventDefault();
							e.stopPropagation();

							const delta = e.deltaY > 0 ? 0.9 : 1.1;
							this.magnifier.zoomFactor = Math.max(2, Math.min(10, this.magnifier.zoomFactor * delta));

							// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
							const rect = this.canvas.getBoundingClientRect();
							const x = e.clientX - rect.left;
							const y = e.clientY - rect.top;
							this.updateMagnifierPosition({ clientX: e.clientX, clientY: e.clientY });

							this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
						}
					});
				}

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª—É–ø—ã (—Ç–æ–≥–ª) - –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–µ –º–µ–Ω—è–µ—Ç activeTool
				toggleMagnifier() {
					this.magnifier.enabled = !this.magnifier.enabled;

					const magnifierBtn = document.getElementById("toolMagnifier");
					if (this.magnifier.enabled) {
						magnifierBtn.classList.add("magnifier-active");
						document.getElementById("magnifierContainer").classList.remove("hidden");
						this.showNotification("Magnifier ON - Shows zoomed area for aiming", "info", 2000);
					} else {
						magnifierBtn.classList.remove("magnifier-active");
						document.getElementById("magnifierContainer").classList.add("hidden");
						this.showNotification("Magnifier OFF", "info", 1000);
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –ª—É–ø–∞ –≤–∫–ª—é—á–µ–Ω–∞
					if (this.magnifier.enabled) {
						this.scheduleRender();
					}
				}

				updateMagnifier() {
					const magnifier = document.getElementById("magnifierContainer");
					if (this.activeTool === "magnifier") {
						magnifier.classList.remove("hidden");
						document.getElementById("magnifier").style.display = "block";
					} else {
						magnifier.classList.add("hidden");
						document.getElementById("magnifier").style.display = "none";
					}
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ª—É–ø—ã
				updateMagnifierPosition(e) {
					if (!this.magnifier.enabled || !this.bufferCtx) return;

					const magnifier = document.getElementById("magnifier");
					const mouseX = e.clientX;
					const mouseY = e.clientY;

					// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ª—É–ø—É —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä)
					const rect = this.canvas.getBoundingClientRect();
					const canvasX = mouseX - rect.left;
					const canvasY = mouseY - rect.top;

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –ª—É–ø—É, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω
					let posX = mouseX + this.magnifier.offsetX;
					let posY = mouseY + this.magnifier.offsetY;

					if (posX + this.magnifier.size > window.innerWidth) {
						posX = mouseX - this.magnifier.size - this.magnifier.offsetX;
					}
					if (posY + this.magnifier.size > window.innerHeight) {
						posY = mouseY - this.magnifier.size - this.magnifier.offsetY;
					}

					magnifier.style.left = posX + "px";
					magnifier.style.top = posY + "px";

					// –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª—É–ø—É
					this.renderMagnifier(canvasX, canvasY);
				}

				// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª—É–ø—ã
				renderMagnifier(canvasX, canvasY) {
					if (!this.bufferCtx || !this.canvasBuffer || !this.magnifier.enabled) return;

					// –ú–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
					const worldX = this.screenToWorldX(canvasX);
					const worldY = this.screenToWorldY(canvasY);

					// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ —Ü–µ–Ω—Ç—Ä –ø–∏–∫—Å–µ–ª—è (–¥–æ–±–∞–≤–ª—è–µ–º 0.5)
					const centerWorldX = Math.floor(worldX) + 0.5;
					const centerWorldY = Math.floor(worldY) + 0.5;

					// –û–ë–©–ò–ô –∑—É–º = –∑—É–º –∫–∞–º–µ—Ä—ã * –∑—É–º –ª—É–ø—ã
					const totalZoom = this.camera.zoom * this.magnifier.zoomFactor;

					// –†–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ –∑–∞—Ö–≤–∞—Ç–∞ (–≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
					const captureSize = this.magnifier.size / totalZoom;
					const halfSize = captureSize / 2;

					// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏ –∑–∞—Ö–≤–∞—Ç–∞ (—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ —Ü–µ–Ω—Ç—Ä –ø–∏–∫—Å–µ–ª—è)
					const captureX = Math.max(0, Math.min(this.canvasWidth - captureSize, centerWorldX - halfSize));
					const captureY = Math.max(0, Math.min(this.canvasHeight - captureSize, centerWorldY - halfSize));

					// –û—á–∏—â–∞–µ–º canvas –ª—É–ø—ã
					this.magnifier.ctx.fillStyle = "#000";
					this.magnifier.ctx.fillRect(0, 0, this.magnifier.size, this.magnifier.size);

					// –ö–æ–ø–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ –ª—É–ø—É –ë–ï–ó –°–ì–õ–ê–ñ–ò–í–ê–ù–ò–Ø
					this.magnifier.ctx.save();
					this.magnifier.ctx.imageSmoothingEnabled = false;

					this.magnifier.ctx.drawImage(this.canvasBuffer, captureX, captureY, captureSize, captureSize, 0, 0, this.magnifier.size, this.magnifier.size);

					this.magnifier.ctx.restore();

					// –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –ø–∏–∫—Å–µ–ª–µ–π –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
					if (this.magnifier.showPixelGrid) {
						this.magnifier.ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
						this.magnifier.ctx.lineWidth = 1;
						const gridSize = totalZoom; // —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –ª—É–ø—ã

						// –°–¥–≤–∏–≥ —Å–µ—Ç–∫–∏ –ø–æ–¥ —Å—É–±–ø–∏–∫—Å–µ–ª—å–Ω—ã–π captureX/captureY (–ø–æ—Å–ª–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ .5)
						// –õ–∏–Ω–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ì–†–ê–ù–ò–¶–ê–ú–ò –ø–∏–∫—Å–µ–ª–µ–π (world coord = integer)
						const gridOffsetX = (Math.ceil(captureX) - captureX) * gridSize;
						const gridOffsetY = (Math.ceil(captureY) - captureY) * gridSize;

						for (let x = gridOffsetX; x <= this.magnifier.size; x += gridSize) {
							this.magnifier.ctx.beginPath();
							this.magnifier.ctx.moveTo(x, 0);
							this.magnifier.ctx.lineTo(x, this.magnifier.size);
							this.magnifier.ctx.stroke();
						}

						for (let y = gridOffsetY; y <= this.magnifier.size; y += gridSize) {
							this.magnifier.ctx.beginPath();
							this.magnifier.ctx.moveTo(0, y);
							this.magnifier.ctx.lineTo(this.magnifier.size, y);
							this.magnifier.ctx.stroke();
						}
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º canvas –ª—É–ø—ã —Å –ø–∏–∫—Å–µ–ª—å–Ω—ã–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
					this.magnifier.canvasElement.width = this.magnifier.size;
					this.magnifier.canvasElement.height = this.magnifier.size;
					const displayCtx = this.magnifier.canvasElement.getContext("2d");

					// –í–´–ö–õ–Æ–ß–ê–ï–ú —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
					displayCtx.imageSmoothingEnabled = false;
					displayCtx.mozImageSmoothingEnabled = false;
					displayCtx.webkitImageSmoothingEnabled = false;
					displayCtx.msImageSmoothingEnabled = false;

					displayCtx.drawImage(this.magnifier.canvas, 0, 0);

					// –†–∏—Å—É–µ–º –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
					if (this.magnifier.showCrosshair) {
						const centerX = this.magnifier.size / 2;
						const centerY = this.magnifier.size / 2;

						displayCtx.strokeStyle = "#FF0000";
						displayCtx.lineWidth = 1;

						// –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
						displayCtx.beginPath();
						displayCtx.moveTo(centerX, 0);
						displayCtx.lineTo(centerX, this.magnifier.size);
						displayCtx.stroke();

						// –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
						displayCtx.beginPath();
						displayCtx.moveTo(0, centerY);
						displayCtx.lineTo(this.magnifier.size, centerY);
						displayCtx.stroke();

						// –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –ø–∏–∫—Å–µ–ª—è
						const pixelSize = totalZoom;
						displayCtx.strokeStyle = "#00FF00";
						displayCtx.lineWidth = 2;
						displayCtx.strokeRect(centerX - pixelSize / 2, centerY - pixelSize / 2, pixelSize, pixelSize);
					}

					// –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø–∏–∫—Å–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
					const pixelX = Math.floor(worldX);
					const pixelY = Math.floor(worldY);
					const colorIndex = (this.pixels && pixelX >= 0 && pixelX < this.canvasWidth && pixelY >= 0 && pixelY < this.canvasHeight)
						? this.pixels[pixelY * this.canvasWidth + pixelX] || 0
						: 0;
					const colors = this.getColorPalette();
					const colorHex = colors[colorIndex] || "#000000";

					// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
					const totalZoomPercent = Math.round(totalZoom * 100);
					document.getElementById("magnifierZoom").textContent = `${this.magnifier.zoomFactor}x (${totalZoomPercent}%)`;
					document.getElementById("magnifierColor").textContent = colorHex;
					document.getElementById("magnifierColor").style.color = colorHex;

					// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (—Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª—è)
					this.updateCoordinates(pixelX, pixelY);
				}
				hideMagnifier() {
					if (this.magnifier.enabled) {
						document.getElementById("magnifierContainer").classList.add("hidden");
					}
				}

				initMinimap() {
					this.minimapCanvas = document.getElementById("minimapCanvas");
					this.minimapCtx = this.minimapCanvas.getContext("2d");
					this.minimapCanvas.width = 150;
					this.minimapCanvas.height = 150;
				}

				initEventListeners() {
					// –ö–æ–ª—ë—Å–∏–∫–æ –º—ã—à–∏ - –∑—É–º
					this.canvas.addEventListener("wheel", e => {
						e.preventDefault();

						const rect = this.canvas.getBoundingClientRect();
						const mouseX = e.clientX - rect.left;
						const mouseY = e.clientY - rect.top;

						// –ú–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –¥–æ –∑—É–º–∞
						const worldX = this.screenToWorldX(mouseX);
						const worldY = this.screenToWorldY(mouseY);

						// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑—É–º–∞
						const delta = e.deltaY > 0 ? 0.9 : 1.1;
						const newZoom = Math.max(this.camera.minZoom, Math.min(this.camera.maxZoom, this.camera.zoom * delta));

						// –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–º–µ—Ä—ã —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –ø–æ–¥ –º—ã—à—å—é –æ—Å—Ç–∞–ª–∞—Å—å –Ω–∞ –º–µ—Å—Ç–µ
						this.camera.x = worldX - mouseX / newZoom;
						this.camera.y = worldY - mouseY / newZoom;
						this.camera.zoom = newZoom;

						this.clampCamera();
						this.updateZoomInfo();
						this.render();
					});

					// –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ - —Ä–∏—Å–æ–≤–∞–Ω–∏–µ/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
					this.canvas.addEventListener("mousedown", e => {
						const rect = this.canvas.getBoundingClientRect();
						this.dragStart = {
							x: e.clientX - rect.left,
							y: e.clientY - rect.top,
							cameraX: this.camera.x,
							cameraY: this.camera.y
						};

						if (e.button === 0) {
							// –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
							if (this.activeTool === "hand") {
								this.isDragging = true;
							} else if (this.activeTool === "pencil") {
								this.handleCanvasClick(e);
							} else if (this.activeTool === "picker") {
								this.handleColorPick(e);
							}
						} else if (e.button === 1) {
							// –°—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞
							this.isDragging = true;
							e.preventDefault();
						}
					});

					// –î–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏
					this.canvas.addEventListener("mousemove", e => {
						const rect = this.canvas.getBoundingClientRect();
						const mouseX = e.clientX - rect.left;
						const mouseY = e.clientY - rect.top;

						// –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
						const worldX = Math.floor(this.screenToWorldX(mouseX));
						const worldY = Math.floor(this.screenToWorldY(mouseY));
						this.updateCoordinates(worldX, worldY);

						// –õ—É–ø–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ document.addEventListener("mousemove")

						// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
						if (this.isDragging) {
							const dx = (mouseX - this.dragStart.x) / (this.canvas.width / (this.canvasWidth / this.camera.zoom));
							const dy = (mouseY - this.dragStart.y) / (this.canvas.height / (this.canvasHeight / this.camera.zoom));

							this.camera.x = this.dragStart.cameraX - dx;
							this.camera.y = this.dragStart.cameraY - dy;

							// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ö–æ–ª—Å—Ç–∞
							this.clampCamera();
							this.render();
						}
					});

					// –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
					document.addEventListener("mouseup", () => {
						this.isDragging = false;
					});

					// –ö–ª–∞–≤–∏—à–∏
					document.addEventListener("keydown", e => {
						this.handleKeyDown(e);
					});

					// –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
					document.getElementById("navZoomIn").addEventListener("click", () => {
						this.camera.zoom = Math.min(this.camera.maxZoom, this.camera.zoom * 1.5);
						this.updateZoomInfo();
						this.render();
					});

					document.getElementById("navZoomOut").addEventListener("click", () => {
						this.camera.zoom = Math.max(this.camera.minZoom, this.camera.zoom / 1.5);
						this.updateZoomInfo();
						this.render();
					});

					document.getElementById("navCenter").addEventListener("click", () => {
						// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∑—É–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ–≥–æ —Ö–æ–ª—Å—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
						const canvasAspectRatio = this.canvasWidth / this.canvasHeight;
						const screenAspectRatio = this.canvas.width / this.canvas.height;

						let optimalZoom;

						if (canvasAspectRatio > screenAspectRatio) {
							// –•–æ–ª—Å—Ç —à–∏—Ä–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∞ - –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
							optimalZoom = this.canvas.width / this.canvasWidth;
						} else {
							// –•–æ–ª—Å—Ç —É–∂–µ –∏–ª–∏ —Ç–∞–∫–æ–π –∂–µ - –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
							optimalZoom = this.canvas.height / this.canvasHeight;
						}

						// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑—É–º (–Ω–µ –º–µ–Ω–µ–µ minZoom)
						this.camera.zoom = Math.max(this.camera.minZoom, optimalZoom);

						// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
						this.camera.x = this.canvasWidth / 2 - this.canvas.width / this.camera.zoom / 2;
						this.camera.y = this.canvasHeight / 2 - this.canvas.height / this.camera.zoom / 2;

						// –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
						this.clampCamera();
						this.updateZoomInfo();
						this.render();

						this.showNotification(`Centered view (zoom: ${Math.round(this.camera.zoom * 100)}%)`, "info", 1500);
					});

					// document.getElementById("navGrid").addEventListener("click", () => {
					// 	this.showGrid = !this.showGrid;
					// 	document.getElementById("gridOverlay").classList.toggle("hidden", !this.showGrid);
					// });

					document.getElementById("navMinimap").addEventListener("click", () => {
						this.showMinimap = !this.showMinimap;
						document.getElementById("minimap").classList.toggle("hidden", !this.showMinimap);
					});

					// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º–∏–Ω–∏–∫–∞—Ä—Ç—ã
					const minimap = document.getElementById("minimap");
					minimap.addEventListener("mousedown", e => {
						const rect = minimap.getBoundingClientRect();
						const x = ((e.clientX - rect.left) / rect.width) * this.canvasWidth;
						const y = ((e.clientY - rect.top) / rect.height) * this.canvasHeight;

						this.camera.x = x;
						this.camera.y = y;
						this.clampCamera();
						this.render();
					});

					document.getElementById("btnReconnect")?.addEventListener("click", () => {
						this.manualReconnect();
					});
				}

				manualReconnect() {
					console.log("üîÑ Manual reconnect requested");

					// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
					this.resetReconnect();

					// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
					this.updateStatus("connecting", "Connecting...");

					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
					this.showNotification("Attempting to reconnect...", "info", 2000);

					// –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
					this.connectToServer(false);
				}

				initTools() {
					// –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
					document.getElementById("toolsPanel").addEventListener("click", e => {
						const toolBtn = e.target.closest(".tool-btn");
						if (!toolBtn) return;

						const toolId = toolBtn.id;
						
						// –õ—É–ø–∞ - —ç—Ç–æ —Ç–æ–≥–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–µ –º–µ–Ω—è–µ—Ç activeTool
						if (toolId === "toolMagnifier") {
							this.toggleMagnifier();
							return;
						}

						const toolMap = {
							toolPencil: "pencil",
							toolHand: "hand",
							toolPicker: "picker"
						};

						if (toolMap[toolId]) {
							this.activeTool = toolMap[toolId];
							this.updateTools();
						}
					});
				}

				updateTools() {
					// –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ (–∫—Ä–æ–º–µ –ª—É–ø—ã - –æ–Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞)
					document.querySelectorAll("#toolsPanel .tool-btn").forEach(btn => {
						if (btn.id !== "toolMagnifier") {
							btn.classList.remove("active");
						}
					});

					// –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
					let activeBtn;
					switch (this.activeTool) {
						case "pencil":
							activeBtn = document.getElementById("toolPencil");
							break;
						case "hand":
							activeBtn = document.getElementById("toolHand");
							break;
						case "picker":
							activeBtn = document.getElementById("toolPicker");
							break;
					}

					if (activeBtn) {
						activeBtn.classList.add("active");
					}

					// –õ—É–ø–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ toggleMagnifier()
					// –ù–µ –º–µ–Ω—è–µ–º –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–µ—Å—å
				}

				getColorPalette() {
					return [
						"#000000",
						"#1A1A1A",
						"#333333",
						"#4D4D4D",
						"#666666",
						"#808080",
						"#999999",
						"#B3B3B3",
						"#CCCCCC",
						"#E6E6E6",
						"#FFFFFF",
						"#FF4444",
						"#FF8844",
						"#FFCC44",
						"#FFFF44",
						"#CCFF44",
						"#88FF44",
						"#44FF44",
						"#44FF88",
						"#44FFCC",
						"#44FFFF",
						"#44CCFF",
						"#4488FF",
						"#4444FF",
						"#8844FF",
						"#CC44FF",
						"#FF44FF",
						"#FF44CC",
						"#FF4488",
						"#FF4444",
						"#FF0000",
						"#00FF00",
						"#0000FF",
						"#FFFF00",
						"#FF00FF",
						"#00FFFF",
						"#FFA500",
						"#800080",
						"#008080",
						"#FFC0CB"
					];
				}

				resizeCanvas() {
					this.canvas.width = window.innerWidth;
					this.canvas.height = window.innerHeight;
					this.render();
				}

				// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –º–∏—Ä–æ–≤—ã–µ
				// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –º–∏—Ä–æ–≤—ã–µ
				screenToWorldX(screenX) {
					return Math.floor(this.camera.x + screenX / this.camera.zoom);
				}

				screenToWorldY(screenY) {
					return Math.floor(this.camera.y + screenY / this.camera.zoom);
				}

				// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ
				worldToScreenX(worldX) {
					return (worldX - this.camera.x) * this.camera.zoom;
				}

				worldToScreenY(worldY) {
					return (worldY - this.camera.y) * this.camera.zoom;
				}

				// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ö–æ–ª—Å—Ç–∞
				clampCamera() {
					const viewWidth = this.canvas.width / this.camera.zoom;
					const viewHeight = this.canvas.height / this.camera.zoom;

					// –ù–µ –¥–∞–µ–º –∫–∞–º–µ—Ä–µ –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ö–æ–ª—Å—Ç–∞
					this.camera.x = Math.max(0, Math.min(this.canvasWidth - viewWidth, this.camera.x));
					this.camera.y = Math.max(0, Math.min(this.canvasHeight - viewHeight, this.camera.y));
				}

				handleCanvasClick(e) {
					const now = Date.now();
					const timeSinceLastClick = now - this.lastClickTime;

					if (timeSinceLastClick < this.cooldownTime) {
						const secondsLeft = Math.ceil((this.cooldownTime - timeSinceLastClick) / 1000);
						this.showNotification(`Wait ${secondsLeft}s before placing next pixel`, "warning");
						return;
					}

					const rect = this.canvas.getBoundingClientRect();
					const screenX = e.clientX - rect.left;
					const screenY = e.clientY - rect.top;

					// –ü–†–ï–û–ë–†–ê–ó–£–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –ü–†–ê–í–ò–õ–¨–ù–û
					const worldX = this.screenToWorldX(screenX);
					const worldY = this.screenToWorldY(screenY);

					// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
					if (worldX < 0 || worldX >= this.canvasWidth || worldY < 0 || worldY >= this.canvasHeight) {
						this.showNotification(`Coordinates out of bounds (0-${this.canvasWidth - 1}, 0-${this.canvasHeight - 1})`, "warning");
						return;
					}

					// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
					if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
						this.ws.send(
							JSON.stringify({
								type: "placePixel",
								x: worldX,
								y: worldY,
								color: this.selectedColor,
								timestamp: now
							})
						);

						this.lastClickTime = now;
						this.updateCooldownTimer();

						// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
						this.setPixel(worldX, worldY, this.selectedColor);
						this.showNotification(`Placed pixel at (${worldX}, ${worldY})`);
					}
				}

				handleColorPick(e) {
					e.preventDefault();

					const rect = this.canvas.getBoundingClientRect();
					const screenX = e.clientX - rect.left;
					const screenY = e.clientY - rect.top;

					const worldX = Math.floor(this.screenToWorldX(screenX));
					const worldY = Math.floor(this.screenToWorldY(screenY));

					if (worldX >= 0 && worldX < this.canvasWidth && worldY >= 0 && worldY < this.canvasHeight) {
						const colorIndex = (this.pixels)
							? this.pixels[worldY * this.canvasWidth + worldX] || 0
							: 0;
						const colors = this.getColorPalette();

						this.selectedColor = colorIndex;

						// –û–±–Ω–æ–≤–ª—è–µ–º UI
						document.querySelectorAll(".color-swatch").forEach(s => {
							s.classList.remove("selected");
							if (parseInt(s.dataset.index) === colorIndex) {
								s.classList.add("selected");
							}
						});

						this.showNotification(`Picked color #${colorIndex}`, "info");
					}
				}

				handleKeyDown(e) {
					const speed = 100 / this.camera.zoom;

					switch (e.key.toLowerCase()) {
						case "arrowup":
							this.camera.y -= speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowdown":
							this.camera.y += speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowleft":
							this.camera.x -= speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowright":
							this.camera.x += speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "+":
						case "=":
							this.camera.zoom = Math.min(this.camera.maxZoom, this.camera.zoom * 1.2);
							this.updateZoomInfo();
							this.render();
							e.preventDefault();
							break;

						case "-":
							this.camera.zoom = Math.max(this.camera.minZoom, this.camera.zoom / 1.2);
							this.updateZoomInfo();
							this.render();
							e.preventDefault();
							break;

						case "0":
							this.camera.x = this.canvasWidth / 2;
							this.camera.y = this.canvasHeight / 2;
							this.camera.zoom = 1.0;
							this.updateZoomInfo();
							this.render();
							break;

						case "h":
							this.activeTool = "hand";
							this.updateTools();
							break;

						case "p":
							this.activeTool = "pencil";
							this.updateTools();
							break;

						case "c":
							this.activeTool = "picker";
							this.updateTools();
							break;

						case "f":
							this.activeTool = "fill";
							this.updateTools();
							break;

						case "g":
							this.showGrid = !this.showGrid;
							document.getElementById("gridOverlay").classList.toggle("hidden", !this.showGrid);
							break;

						case "m":
							// M - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª—É–ø—ã (—Ç–æ–≥–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
							this.toggleMagnifier();
							e.preventDefault();
							break;

						case "[":
							if (this.magnifier.enabled) {
								this.magnifier.zoomFactor = Math.max(2, this.magnifier.zoomFactor - 1);
								const rect = this.canvas.getBoundingClientRect();
								this.updateMagnifierPosition({
									clientX: rect.left + this.canvas.width / 2,
									clientY: rect.top + this.canvas.height / 2
								});
								this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
								e.preventDefault();
							}
							break;

						case "]":
							if (this.magnifier.enabled) {
								this.magnifier.zoomFactor = Math.min(10, this.magnifier.zoomFactor + 1);
								const rect = this.canvas.getBoundingClientRect();
								this.updateMagnifierPosition({
									clientX: rect.left + this.canvas.width / 2,
									clientY: rect.top + this.canvas.height / 2
								});
								this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
								e.preventDefault();
							}
							break;

						case "escape":
							// –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å Wallpaper Engine
							break;
					}
				}

				setPixel(x, y, color) {
					if (!this.pixels || x < 0 || x >= this.canvasWidth || y < 0 || y >= this.canvasHeight) return;

					const index = y * this.canvasWidth + x;
					this.pixels[index] = color;

					// –û–±–Ω–æ–≤–ª—è–µ–º ImageData
					if (this.imageData && this.bufferCtx) {
						this.updatePixelInImageData(x, y, color);
						// –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –±—É—Ñ–µ—Ä—É (—Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø–∏–∫—Å–µ–ª—å)
						this.bufferCtx.putImageData(this.imageData, 0, 0, x, y, 1, 1);
					}

					// –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
					this.scheduleRender();
				}

				drawPixel(x, y, colorIndex) {
					const colors = this.getColorPalette();
					const color = colors[colorIndex] || colors[0];

					// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ
					const screenX = this.worldToScreenX(x);
					const screenY = this.worldToScreenY(y);
					const pixelSize = Math.max(1, this.camera.zoom);

					this.ctx.fillStyle = color;
					this.ctx.fillRect(screenX, screenY, pixelSize, pixelSize);
				}

				initCanvasBuffer() {
					this.canvasBuffer = document.createElement("canvas");
					this.canvasBuffer.width = this.canvasWidth;
					this.canvasBuffer.height = this.canvasHeight;
					this.bufferCtx = this.canvasBuffer.getContext("2d");

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Uint8Array –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ –ø–∏–∫—Å–µ–ª–µ–π (1 –±–∞–π—Ç –Ω–∞ –ø–∏–∫—Å–µ–ª—å)
					const totalPixels = this.canvasWidth * this.canvasHeight;
					this.pixels = new Uint8Array(totalPixels);
					this.pixels.fill(0); // –ß–µ—Ä–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

					// –°–æ–∑–¥–∞–µ–º ImageData –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
					this.imageData = this.bufferCtx.createImageData(this.canvasWidth, this.canvasHeight);
					// –ó–∞–ª–∏–≤–∞–µ–º —á–µ—Ä–Ω—ã–º (RGBA: 0,0,0,255)
					const data = this.imageData.data;
					for (let i = 0; i < data.length; i += 4) {
						data[i] = 0;     // R
						data[i + 1] = 0; // G
						data[i + 2] = 0; // B
						data[i + 3] = 255; // A
					}
					this.bufferCtx.putImageData(this.imageData, 0, 0);

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
					this.bufferCtx.imageSmoothingEnabled = false;
					this.ctx.imageSmoothingEnabled = false;
				}

				// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ –ø–∞–ª–∏—Ç—Ä—ã –≤ RGBA
				colorIndexToRGBA(colorIndex) {
					const colors = this.getColorPalette();
					const hex = colors[colorIndex] || colors[0];
					// –ü–∞—Ä—Å–∏–º hex (#RRGGBB) –≤ RGB
					const r = parseInt(hex.slice(1, 3), 16);
					const g = parseInt(hex.slice(3, 5), 16);
					const b = parseInt(hex.slice(5, 7), 16);
					return [r, g, b, 255];
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è –≤ ImageData
				updatePixelInImageData(x, y, colorIndex) {
					if (!this.imageData || x < 0 || x >= this.canvasWidth || y < 0 || y >= this.canvasHeight) return;
					
					const index = (y * this.canvasWidth + x) * 4;
					const [r, g, b] = this.colorIndexToRGBA(colorIndex);
					
					this.imageData.data[index] = r;
					this.imageData.data[index + 1] = g;
					this.imageData.data[index + 2] = b;
					this.imageData.data[index + 3] = 255;
				}

				// –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é render:
				render() {
					if (!this.bufferCtx || !this.canvasBuffer) {
						// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞ –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤
						this.ctx.fillStyle = "#0a0a0a";
						this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
						return;
					}

					// –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
					this.ctx.fillStyle = "#0a0a0a";
					this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

					// –í—ã—á–∏—Å–ª—è–µ–º –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å –≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
					const visibleMinX = Math.max(0, Math.floor(this.camera.x));
					const visibleMaxX = Math.min(this.canvasWidth, Math.ceil(this.camera.x + this.canvas.width / this.camera.zoom));
					const visibleMinY = Math.max(0, Math.floor(this.camera.y));
					const visibleMaxY = Math.min(this.canvasHeight, Math.ceil(this.camera.y + this.canvas.height / this.camera.zoom));

					const bufferWidth = visibleMaxX - visibleMinX;
					const bufferHeight = visibleMaxY - visibleMinY;

					if (bufferWidth <= 0 || bufferHeight <= 0) return;

					// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
					const screenX = (visibleMinX - this.camera.x) * this.camera.zoom;
					const screenY = (visibleMinY - this.camera.y) * this.camera.zoom;
					const screenWidth = bufferWidth * this.camera.zoom;
					const screenHeight = bufferHeight * this.camera.zoom;

					// –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º canvas
					this.ctx.imageSmoothingEnabled = false;
					this.ctx.mozImageSmoothingEnabled = false;
					this.ctx.webkitImageSmoothingEnabled = false;
					this.ctx.msImageSmoothingEnabled = false;

					// –†–∏—Å—É–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
					// –í–∞–∂–Ω–æ: –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö canvas (—ç—Ç–æ —Å–∏–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç CPU/GPU –∏ –∞–ª–ª–æ–∫–∞—Ü–∏–∏)
					this.ctx.drawImage(this.canvasBuffer, visibleMinX, visibleMinY, bufferWidth, bufferHeight, screenX, screenY, screenWidth, screenHeight);

					// –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É
					this.updateMinimap();
				}

				updateMinimap() {
					if (!this.showMinimap || !this.minimapCtx || !this.bufferCtx) return;

					// –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –º–∏–Ω–∏–∫–∞—Ä—Ç—ã ‚Äî —Ä–∏—Å–æ–≤–∞—Ç—å –µ—ë –∫–∞–∂–¥—ã–π render —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ
					if (this.minimapFps === undefined) this.minimapFps = 10;
					if (this.lastMinimapUpdate === undefined) this.lastMinimapUpdate = 0;
					const now = performance.now();
					const minInterval = 1000 / this.minimapFps;
					if (now - this.lastMinimapUpdate < minInterval) return;
					this.lastMinimapUpdate = now;

					// –û—á–∏—â–∞–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É
					this.minimapCtx.fillStyle = "#1a1a1a";
					this.minimapCtx.fillRect(0, 0, 150, 150);

					// –ú–∞—Å—à—Ç–∞–± –¥–ª—è –º–∏–Ω–∏–∫–∞—Ä—Ç—ã
					const scaleX = 150 / this.canvasWidth;
					const scaleY = 150 / this.canvasHeight;
					const scale = Math.min(scaleX, scaleY);

					// –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±—É—Ñ–µ—Ä–∞
					this.minimapCtx.drawImage(this.canvasBuffer, 0, 0, this.canvasWidth, this.canvasHeight, 0, 0, this.canvasWidth * scale, this.canvasHeight * scale);

					// –†–∏—Å—É–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
					const viewX = this.camera.x * scale;
					const viewY = this.camera.y * scale;
					const viewWidth = (this.canvas.width / this.camera.zoom) * scale;
					const viewHeight = (this.canvas.height / this.camera.zoom) * scale;

					const viewport = document.getElementById("minimapViewport");
					viewport.style.left = `${viewX}px`;
					viewport.style.top = `${viewY}px`;
					viewport.style.width = `${viewWidth}px`;
					viewport.style.height = `${viewHeight}px`;
				}

				updateCoordinates(x, y) {
					document.getElementById("coordX").textContent = x;
					document.getElementById("coordY").textContent = y;
				}

				updateZoomInfo() {
					const zoomPercent = Math.round(this.camera.zoom * 100);
					document.getElementById("zoomValue").textContent = `${zoomPercent}%`;
				}

				updateCooldownTimer() {
					const timerElement = document.getElementById("cooldownTimer");
					const updateTimer = () => {
						const now = Date.now();
						const timeLeft = Math.max(0, this.cooldownTime - (now - this.lastClickTime));

						if (timeLeft <= 0) {
							timerElement.textContent = "Ready";
							timerElement.style.color = "#4CAF50";
						} else {
							const seconds = Math.ceil(timeLeft / 1000);
							timerElement.textContent = `${seconds}s`;
							timerElement.style.color = seconds <= 5 ? "#4CAF50" : "#FF9800";
						}
					};

					updateTimer();
					if (this.cooldownInterval) clearInterval(this.cooldownInterval);
					this.cooldownInterval = setInterval(updateTimer, 1000);
				}

				updateFPS() {
					const now = performance.now();
					this.frameCount++;

					if (now - this.lastFpsUpdate >= 1000) {
						this.fps = Math.round((this.frameCount * 1000) / (now - this.lastFpsUpdate));
						this.frameCount = 0;
						this.lastFpsUpdate = now;

						document.getElementById("fpsCounter").textContent = this.fps;
					}
				}

				updateLoader(title, progress) {
					// –ü—Ä–∏ —Ç–∏—Ö–æ–º —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
					if (this.quietReconnect && progress < 100) return;

					document.getElementById("loaderTitle").textContent = title;
					document.getElementById("loaderProgress").style.width = `${progress}%`;

					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
					if (progress > 0 && progress < 100 && !this.quietReconnect) {
						document.getElementById("loader").classList.remove("hidden");
					}
				}

				connectToServer(quiet = true) {
					// –ï—Å–ª–∏ —É–∂–µ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∏–º—Å—è - –≤—ã—Ö–æ–¥–∏–º
					if (this.isReconnecting && this.reconnectTimeout) return;

					this.quietReconnect = quiet;

					// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
					if (this.reconnectTimeout) {
						clearTimeout(this.reconnectTimeout);
						this.reconnectTimeout = null;
					}

					const wsUrl = `ws://${this.serverConfig.host}:${this.serverConfig.port}${this.serverConfig.path}`;

					// –¢–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
					if (!quiet) {
						this.updateStatus("connecting", "Connecting...");
						this.updateLoader("Connecting to server...", 0);
					} else {
						// –î–ª—è —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
						this.isReconnecting = true;
						this.updateStatus("connecting", "Reconnecting...");

						// –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
						document.getElementById("loader").classList.add("hidden");
					}

					try {
						this.ws = new WebSocket(wsUrl);
						this.ws.binaryType = "arraybuffer";

						this.ws.onopen = () => {
							console.log("‚úÖ WebSocket connected successfully");
							this.isConnected = true;

							// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
							this.resetReconnect();

							// –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
							this.updateStatus("connected", "Connected");

							if (!quiet) {
								this.updateLoader("Requesting canvas...", 10);
							} else {
								this.showNotification("Reconnected to server", "info", 2000);
							}

							// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç
							this.ws.send(JSON.stringify({ type: "getCanvas" }));

							// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω
							this.ws.send(JSON.stringify({ type: "getOnline" }));

							this.startPing();
						};

						this.ws.onmessage = event => {
							// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
							console.log("üì• Received message:", event.data instanceof ArrayBuffer ? "Binary" : "Text", event.data instanceof ArrayBuffer ? event.data.byteLength : event.data.length);

							if (event.data instanceof ArrayBuffer) {
								if (this.expectingBinaryData) {
									this.processBinaryChunk(event.data);
									this.expectingBinaryData = false;
								} else {
									console.warn("‚ö†Ô∏è Unexpected binary data received");
									this.processBinaryChunk(event.data);
								}
							} else {
								try {
									const data = JSON.parse(event.data);
									console.log("üì• Parsed JSON:", data.type, data);
									this.handleServerMessage(data);
								} catch (error) {
									console.error("‚ùå Error parsing message:", error, "Data:", event.data);
								}
							}
						};

						this.ws.onclose = event => {
							console.log("üîå WebSocket closed:", event.code, event.reason);
							this.isConnected = false;
							this.isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥

							// –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
							this.updateStatus("disconnected", "Disconnected");

							// –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
							document.getElementById("loader").classList.add("hidden");

							// –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–∫–æ–¥ 1000) - –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
							if (event.code !== 1000) {
								console.log("üîÑ Reconnect triggered from onclose");
								this.attemptReconnect();
							}
						};

						this.ws.onerror = error => {
							console.error("‚ùå WebSocket error:", error);
							this.isConnected = false;
							this.isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞

							// –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏
							this.updateStatus("disconnected", "Connection error");

							// –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
							document.getElementById("loader").classList.add("hidden");

							// –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
							console.log("üîÑ Immediate reconnect attempt from onerror");
							this.attemptReconnect();
						};
					} catch (error) {
						console.error("‚ùå Failed to create WebSocket:", error);
						this.updateStatus("disconnected", "Connection failed");

						if (!quiet) {
							this.updateLoader("Connection failed. Running in offline mode.", 100);
							setTimeout(() => {
								document.getElementById("loader").classList.add("hidden");
							}, 2000);
						}

						this.attemptReconnect();
					}
				}

				attemptReconnect() {
					// –ï—Å–ª–∏ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ - –≤—ã—Ö–æ–¥–∏–º

					if (this.reconnectAttempts >= this.maxReconnectAttempts) {
						console.log("‚ùå Max reconnect attempts reached");
						this.updateStatus("disconnected", "No connection");
						this.showNotification("Cannot connect to server. Please check your connection and refresh the page.", "error", 5000);
						this.isReconnecting = false;
						return;
					}

					// –ï—Å–ª–∏ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ - –≤—ã—Ö–æ–¥–∏–º
					if (this.isReconnecting) {
						console.log("‚è∏Ô∏è Reconnect already in progress");
						return;
					}

					// –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
					this.reconnectAttempts++;
					this.isReconnecting = true;

					// –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
					const delay = Math.min(this.maxReconnectDelay, this.reconnectDelay * Math.pow(1.5, this.reconnectAttempts - 1));

					console.log(`üîÅ Reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${delay}ms`);

					// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
					this.updateStatus("connecting", `Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

					// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
					if (this.reconnectTimeout) {
						clearTimeout(this.reconnectTimeout);
					}

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
					this.reconnectTimeout = setTimeout(() => {
						console.log("üîÑ Executing reconnect...");
						this.isReconnecting = false;
						this.connectToServer(true); // –¢–∏—Ö–∏–π —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
					}, delay);
				}

				resetReconnect() {
					console.log("üîÑ Resetting reconnect counter");
					this.reconnectAttempts = 0;
					this.reconnectDelay = 2000;
					this.isReconnecting = false;

					// –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
					if (this.reconnectTimeout) {
						clearTimeout(this.reconnectTimeout);
						this.reconnectTimeout = null;
					}
				}

				handleServerMessage(data) {
					switch (data.type) {
						case "welcome":
							// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
							this.canvasWidth = data.canvas.width || 800;
							this.canvasHeight = data.canvas.height || 800;
							this.cooldownTime = data.cooldown || 1000;
							this.usersOnline = data.online || 0;

							// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
							this.initCanvasBuffer();

							// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
							this.camera.x = this.canvasWidth / 2 - this.canvas.width / this.camera.zoom / 2;
							this.camera.y = this.canvasHeight / 2 - this.canvas.height / this.camera.zoom / 2;
							this.clampCamera();

							// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç
							this.ws.send(JSON.stringify({ type: "getCanvas" }));
							break;
						case "canvasInfo":
							this.canvasWidth = data.width || 800;
							this.canvasHeight = data.height || 800;
							this.totalChunks = data.totalChunks || 1;
							this.loadedChunks = new Set();
							this.loadedChunkCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

							// –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
							this.initCanvasBuffer();
							break;
						case "chunkMeta":
							this.handleChunkMeta(data);
							break;
						case "canvasComplete":
							this.handleCanvasComplete();
							break;
						case "pixelUpdate":
							this.handlePixelUpdate(data);
							break;
						case "onlineCount":
							this.usersOnline = data.count;
							document.getElementById("onlineCount").textContent = data.count;
							break;
						case "welcome":
							this.canvasWidth = data.canvas.width || 8192;
							this.canvasHeight = data.canvas.height || 8192;
							this.cooldownTime = data.cooldown || 1000;
							this.usersOnline = data.online || 0;
							document.getElementById("onlineCount").textContent = this.usersOnline;
							break;
						case "canvasChunk":
							this.loadCanvasChunk(data);
							break;
						case "pixelPlaced":
							this.lastClickTime = data.timestamp;
							this.updateCooldownTimer();
							break;

						case "cooldown":
							const seconds = Math.ceil(data.timeLeft / 1000);
							this.showNotification(`Cooldown: ${seconds}s remaining`, "warning");
							break;
						case "pong":
							console.log("Stopping ping interval");
							this.lastPongTime = Date.now();
							break;
						case "error":
							this.showNotification(data.message, "error");
							break;
					}
				}

				startPing() {
					// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
					if (this.pingInterval) clearInterval(this.pingInterval);

					this.pingInterval = setInterval(() => {
						if (this.ws && this.ws.readyState === WebSocket.OPEN) {
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π pong
							if (this.lastPongTime > 0 && Date.now() - this.lastPongTime > this.pingTimeout) {
								console.warn("Ping timeout, reconnecting...");
								this.ws.close();
								this.attemptReconnect();
								return;
							}

							console.log("Stopping ping interval");
							// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping
							this.ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
						}
					}, 10000); // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
				}

				stopPing() {
					if (this.pingInterval) {
						clearInterval(this.pingInterval);
						this.pingInterval = null;
					}
				}

				// –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
				handleCanvasInfo(info) {
					console.log("üé® Canvas info received:", info);

					this.canvasWidth = info.width;
					this.canvasHeight = info.height;
					this.totalChunks = info.totalChunks;
					this.chunkSize = info.chunkSize;
					this.totalPixels = info.totalPixels || info.width * info.height;

					console.log(`üé® Canvas: ${this.canvasWidth}x${this.canvasHeight}, ${this.totalPixels} pixels, ${this.totalChunks} chunks`);

					this.updateLoader(`Canvas: ${info.width}x${info.height}`, 5);

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
					if (!this.canvasBuffer) {
						this.canvasBuffer = document.createElement("canvas");
						this.canvasBuffer.width = this.canvasWidth;
						this.canvasBuffer.height = this.canvasHeight;
						this.bufferCtx = this.canvasBuffer.getContext("2d");

						// –ó–∞–ª–∏–≤–∞–µ–º —á–µ—Ä–Ω—ã–º
						this.bufferCtx.fillStyle = "#000";
						this.bufferCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
					}
				}

				handleChunkMeta(meta) {
					console.log("üì¶ Chunk metadata:", meta);

					this.lastChunkStart = meta.start;
					this.currentChunkIndex = meta.chunkIndex;
					this.currentChunkSize = meta.size || meta.end - meta.start;

					// –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞–Ω–∫–∞
					this.expectingBinaryData = true;

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					const progress = Math.min(100, Math.round(((meta.chunkIndex + 1) / this.totalChunks) * 95));

					this.updateLoader(`Loading chunk ${meta.chunkIndex + 1}/${this.totalChunks} (${progress}%)`, progress);
				}

				loadCanvasChunk(data) {
					// –î–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
					if (data instanceof ArrayBuffer) {
						this.processBinaryChunk(data);
					} else if (typeof data === "string") {
						// JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
						try {
							const message = JSON.parse(data);
							this.handleChunkMetadata(message);
						} catch (e) {
							console.error("Error parsing message:", e);
						}
					}
				}

				// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è processBinaryChunk:
				processBinaryChunk(binaryData) {
					if (!this.bufferCtx || !this.pixels || !this.imageData) return;

					const uint8Array = new Uint8Array(binaryData);
					const chunkStart = this.lastChunkStart || 0;
					const chunkSize = uint8Array.length;

					// –û–±–Ω–æ–≤–ª—è–µ–º Uint8Array –∏ ImageData –ø–∞–∫–µ—Ç–Ω–æ
					for (let i = 0; i < chunkSize; i++) {
						const globalIndex = chunkStart + i;
						if (globalIndex >= this.pixels.length) break;

						const x = globalIndex % this.canvasWidth;
						const y = Math.floor(globalIndex / this.canvasWidth);
						const color = uint8Array[i];

						// –û–±–Ω–æ–≤–ª—è–µ–º Uint8Array
						this.pixels[globalIndex] = color;

						// –û–±–Ω–æ–≤–ª—è–µ–º ImageData (–¥–∞–∂–µ –µ—Å–ª–∏ —Ü–≤–µ—Ç 0 - —á–µ—Ä–Ω—ã–π)
						this.updatePixelInImageData(x, y, color);
					}

					// –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –±—É—Ñ–µ—Ä—É –ø–∞–∫–µ—Ç–Ω–æ
					// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å—å ImageData –∫–∞–∂–¥—ã–µ N —á–∞–Ω–∫–æ–≤ –∏–ª–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —á–∞–Ω–∫–æ–≤
					// –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –≤—ã—á–∏—Å–ª—è—Ç—å –∏ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
					if (this.loadedChunkCount % 5 === 0 || chunkSize > 5000) {
						// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å—å –±—É—Ñ–µ—Ä —Ü–µ–ª–∏–∫–æ–º (–±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ)
						this.bufferCtx.putImageData(this.imageData, 0, 0);
					}
					// –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –≤ imageData, –ø—Ä–∏–º–µ–Ω–∏–º –∏—Ö –ø–æ–∑–∂–µ

					this.loadedChunkCount++;

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					if (this.totalChunks > 0) {
						const progress = Math.min(95, Math.round((this.loadedChunkCount / this.totalChunks) * 95));
						this.updateLoader(`Loading... ${progress}%`, progress);
					}

					// –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–µ 5 —á–∞–Ω–∫–æ–≤ (scheduleRender –≤–º–µ—Å—Ç–æ render –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
					if (this.loadedChunkCount % 5 === 0) {
						this.scheduleRender();
					}
				}

				handleChunkMetadata(meta) {
					switch (meta.type) {
						case "canvasInfo":
							this.canvasWidth = meta.width;
							this.canvasHeight = meta.height;
							this.totalChunks = meta.totalChunks;
							this.chunkSize = meta.chunkSize;
							this.totalPixels = meta.width * meta.height;
							this.updateLoader("Starting canvas load...", 5);

							console.log("Received chunk size:", meta);
							break;

						case "chunkMeta":
							this.lastChunkStart = meta.start;
							break;

						case "canvasComplete":
							this.handleCanvasComplete();
							break;
					}
				}

				// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
				scheduleRender() {
					if (!this.isRendering) {
						this.isRendering = true;
						requestAnimationFrame(() => {
							this.render();
							this.isRendering = false;
						});
					}
				}

				handleCanvasComplete() {
					console.log("‚úÖ Canvas loading complete!");

					// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π ImageData –∫ –±—É—Ñ–µ—Ä—É (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
					if (this.imageData && this.bufferCtx) {
						this.bufferCtx.putImageData(this.imageData, 0, 0);
					}

					// –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
					this.scheduleRender();

					if (!this.quietReconnect) {
						// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
						this.updateLoader("Canvas loaded!", 100);
						setTimeout(() => {
							document.getElementById("loader").classList.add("hidden");
							this.showNotification(`Canvas loaded: ${this.canvasWidth}x${this.canvasHeight}`, "info");
						}, 500);
					} else {
						// –ü—Ä–∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–µ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –µ—Å–ª–∏ –æ–Ω –≤–∏–¥–µ–Ω
						document.getElementById("loader").classList.add("hidden");
						// –ë–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å
					}

					// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
					if (!this.quietReconnect) {
						this.camera.x = this.canvasWidth / 2 - this.canvas.width / this.camera.zoom / 2;
						this.camera.y = this.canvasHeight / 2 - this.canvas.height / this.camera.zoom / 2;
						this.clampCamera();
						this.updateZoomInfo();
						this.scheduleRender();
					}
				}

				handlePixelUpdate(data) {
					const { x, y, color } = data;
					this.setPixel(x, y, color);
					this.scheduleRender();
				}

				updateStatus(status, text) {
					const statusPanel = document.getElementById("statusPanel");
					const statusText = document.getElementById("statusText");
					const statusCompactText = document.getElementById("statusCompactText");
					const statusDot = statusPanel.querySelector(".status-dot");

					// –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–æ—á–∫–∏
					statusPanel.className = "ui-panel " + status;
					statusText.textContent = text;

					// –î–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
					if (status === "connecting") {
						statusCompactText.textContent = "Connecting...";
					} else if (status === "connected") {
						statusCompactText.textContent = "Online";
					} else {
						statusCompactText.textContent = "Offline";
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ç–æ—á–∫–∏
					const dotColors = {
						connected: "#4caf50",
						connecting: "#ff9800",
						disconnected: "#f44336"
					};

					if (statusDot && dotColors[status]) {
						statusDot.style.backgroundColor = dotColors[status];
						statusDot.style.boxShadow = `0 0 10px ${dotColors[status]}`;
					}

					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞
					const reconnectBtn = document.getElementById("btnReconnect");
					if (reconnectBtn) {
						reconnectBtn.style.display = status === "disconnected" ? "block" : "none";
					}
				}

				cleanup() {
					this.stopPing();
					// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
					if (this.ws && this.ws.readyState === WebSocket.OPEN) {
						this.ws.close(1000, "Page closing");
					}

					// –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã
					if (this.reconnectTimeout) {
						clearTimeout(this.reconnectTimeout);
					}

					if (this.cooldownInterval) {
						clearInterval(this.cooldownInterval);
					}
				}

				showNotification(message, type = "info", duration = 3000) {
					// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–µ
					if (this.isReconnecting && type === "error" && message.includes("Disconnected")) {
						return;
					}

					const oldNotifications = document.querySelectorAll(".notification");
					oldNotifications.forEach(n => n.remove());

					const notification = document.createElement("div");
					notification.className = `notification ${type}`;
					notification.textContent = message;
					document.body.appendChild(notification);

					setTimeout(() => notification.remove(), duration);
				}

				animate() {
					requestAnimationFrame(() => this.animate());
				}
			}

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
			window.addEventListener("load", () => {
				window.pixelWall = new PixelBattleWallpaper();
			});

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
			window.addEventListener("beforeunload", () => {
				this.cleanup();
			});
		</script>
	</body>
</html>
