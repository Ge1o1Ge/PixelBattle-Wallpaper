<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PixelBattle Mega Canvas</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				user-select: none;
				-webkit-user-select: none;
			}

			body {
				overflow: hidden;
				width: 100vw;
				height: 100vh;
				background: linear-gradient(45deg, #0a0a0a 0%, #1a1a1a 100%);
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				cursor: crosshair;
			}

			#mainCanvas {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				image-rendering: pixelated;
				image-rendering: crisp-edges;
			}

			/* –°—Ç–∞—Ç—É—Å –±–∞—Ä - —É–ª—É—á—à–µ–Ω–Ω—ã–π */
			#statusBar {
				position: absolute;
				top: 10px;
				right: 10px;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 12px 16px;
				border-radius: 10px;
				font-size: 12px;
				display: flex;
				align-items: center;
				gap: 12px;
				z-index: 100;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				transition: all 0.3s ease;
			}

			#statusBar:hover {
				background: rgba(0, 0, 0, 0.95);
				border-color: rgba(255, 255, 255, 0.25);
			}

			.status-item {
				display: flex;
				align-items: center;
				gap: 6px;
				white-space: nowrap;
			}

			.status-dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				transition: background-color 0.3s;
			}

			.connected .status-dot {
				background: #4caf50;
				box-shadow: 0 0 10px #4caf50;
			}
			.connecting .status-dot {
				background: #ff9800;
				box-shadow: 0 0 10px #ff9800;
				animation: pulse 1.5s infinite;
			}
			.disconnected .status-dot {
				background: #f44336;
				box-shadow: 0 0 10px #f44336;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			#cooldownTimer {
				color: #4caf50;
				font-weight: bold;
				font-size: 13px;
				min-width: 40px;
			}

			.status-label {
				opacity: 0.8;
				font-size: 11px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ */
			#colorPalette {
				position: absolute;
				top: 50%;
				right: 10px;
				transform: translateY(-50%);
				background: rgba(0, 0, 0, 0.85);
				border-radius: 12px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 100;
				overflow: hidden;
				transition: all 0.3s ease;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				max-height: 70vh;
			}

			.palette-compact {
				display: flex;
				flex-direction: column;
				padding: 10px;
				gap: 6px;
			}

			.color-row {
				display: flex;
				gap: 6px;
			}

			.color-swatch {
				width: 32px;
				height: 32px;
				border-radius: 8px;
				cursor: pointer;
				border: 2px solid transparent;
				transition: all 0.2s ease;
				position: relative;
			}

			.color-swatch:hover {
				transform: scale(1.1);
				box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
			}

			.color-swatch.selected {
				border-color: white;
				transform: scale(1.1);
				box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
			}

			.color-swatch.selected::after {
				content: "‚úì";
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: white;
				font-size: 14px;
				font-weight: bold;
				text-shadow: 0 0 3px black;
			}

			/* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
			#navPanel {
				position: absolute;
				bottom: 20px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(0, 0, 0, 0.85);
				padding: 12px 20px;
				border-radius: 12px;
				display: flex;
				gap: 15px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 90;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			#navPanel:hover {
				opacity: 1;
			}

			.nav-item {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 4px;
				cursor: pointer;
				color: white;
				padding: 8px 12px;
				border-radius: 8px;
				transition: background 0.3s;
				min-width: 60px;
			}

			.nav-item:hover {
				background: rgba(255, 255, 255, 0.1);
			}

			.nav-item i {
				font-size: 20px;
				margin-bottom: 2px;
			}

			.nav-item span {
				font-size: 10px;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				opacity: 0.8;
			}

			/* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑—É–º–µ */
			#zoomInfo {
				position: absolute;
				bottom: 20px;
				left: 20px;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 10px 15px;
				border-radius: 10px;
				font-size: 12px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 90;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			#zoomInfo:hover {
				opacity: 1;
			}

			.zoom-value {
				font-size: 14px;
				font-weight: bold;
				color: #4caf50;
				margin-left: 5px;
			}

			/* –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ */
			#minimap {
				position: absolute;
				top: 70px;
				right: 20px;
				width: 150px;
				height: 150px;
				background: rgba(0, 0, 0, 0.85);
				border-radius: 8px;
				backdrop-filter: blur(10px);
				border: 2px solid rgba(255, 255, 255, 0.2);
				z-index: 95;
				overflow: hidden;
				opacity: 0.5;
				transition: opacity 0.3s;
			}

			#minimap:hover {
				opacity: 1;
			}

			#minimapCanvas {
				width: 100%;
				height: 100%;
			}

			.minimap-viewport {
				position: absolute;
				border: 2px solid #4caf50;
				background: rgba(76, 175, 80, 0.1);
				pointer-events: none;
			}

			/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
			.notification {
				position: absolute;
				top: 70px;
				left: 20px;
				background: rgba(0, 0, 0, 0.9);
				color: white;
				padding: 15px 20px;
				border-radius: 10px;
				backdrop-filter: blur(10px);
				border-left: 4px solid #4caf50;
				z-index: 200;
				animation:
					slideInLeft 0.3s,
					fadeOut 0.3s 2.7s;
				max-width: 350px;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				pointer-events: none;
			}

			.notification.error {
				border-left-color: #f44336;
			}

			.notification.warning {
				border-left-color: #ff9800;
			}

			.notification.info {
				border-left-color: #2196f3;
			}

			@keyframes slideInLeft {
				from {
					transform: translateX(-100%);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}

			@keyframes fadeOut {
				to {
					opacity: 0;
				}
			}

			/* –õ–æ–∞–¥–µ—Ä */
			#loader {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				text-align: center;
				color: white;
				z-index: 1000;
				background: rgba(0, 0, 0, 0.9);
				padding: 30px 40px;
				border-radius: 15px;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				min-width: 300px;
			}

			.spinner {
				border: 3px solid rgba(255, 255, 255, 0.1);
				border-top: 3px solid #4caf50;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
				margin: 0 auto 15px;
			}

			.progress-bar {
				width: 100%;
				height: 4px;
				background: rgba(255, 255, 255, 0.1);
				border-radius: 2px;
				margin: 15px 0;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				background: #4caf50;
				width: 0%;
				transition: width 0.3s;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			/* –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ */
			#quickTools {
				position: absolute;
				top: 70px;
				left: 20px;
				display: flex;
				flex-direction: column;
				gap: 10px;
				z-index: 100;
			}

			.tool-btn {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.85);
				border: 1px solid rgba(255, 255, 255, 0.15);
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				backdrop-filter: blur(10px);
				transition: all 0.3s;
				font-size: 18px;
				opacity: 0.7;
			}

			.tool-btn:hover {
				opacity: 1;
				transform: scale(1.1);
				background: rgba(0, 0, 0, 0.95);
			}

			.tool-btn.active {
				background: #4caf50;
				color: white;
				opacity: 1;
			}

			/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
			#coordIndicator {
				position: absolute;
				bottom: 80px;
				right: 20px;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 8px 12px;
				border-radius: 8px;
				font-size: 11px;
				font-family: monospace;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.15);
				z-index: 90;
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			#coordIndicator:hover {
				opacity: 1;
			}

			/* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
			.hidden {
				display: none !important;
			}

			/* –°–µ—Ç–∫–∞ */
			.grid-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				opacity: 0.1;
				background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
				background-size: 20px 20px;
			}

			/* –õ—É–ø–∞ */
			/* –õ—É–ø–∞ - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
			#magnifierContainer {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				z-index: 150;
			}

			#magnifier {
				position: absolute;
				width: 200px;
				height: 200px;
				background: rgba(0, 0, 0, 0.95);
				border: 3px solid rgba(255, 255, 255, 0.3);
				box-shadow:
					0 0 0 1px rgba(0, 0, 0, 0.8),
					0 0 30px rgba(0, 0, 0, 0.6),
					0 0 0 2px rgba(255, 255, 255, 0.1) inset,
					0 0 20px rgba(0, 0, 0, 0.8);
				overflow: hidden;
				backdrop-filter: blur(1px);
				transform: translate(0, 0);
				display: block;
				border-radius: 4px;
			}

			#magnifierCanvas {
				width: 100%;
				height: 100%;
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				display: block;
			}

			#magnifierCrosshair {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
			}

			#magnifierInfo {
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				background: rgba(0, 0, 0, 0.85);
				color: white;
				padding: 6px 8px;
				font-size: 10px;
				display: flex;
				justify-content: space-between;
				backdrop-filter: blur(5px);
				border-top: 1px solid rgba(255, 255, 255, 0.2);
				font-family: monospace;
			}

			#magnifierZoom {
				color: #4caf50;
				font-weight: bold;
			}

			#magnifierColor {
				font-weight: bold;
			}

			/* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ª—É–ø—ã */
			.tool-btn.magnifier-active {
				background: #2196f3;
				color: white;
				box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
				animation: pulse-magnifier 2s infinite;
			}

			@keyframes pulse-magnifier {
				0%,
				100% {
					box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
				}
				50% {
					box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
				}
			}
		</style>
	</head>
	<body>
		<canvas id="mainCanvas"></canvas>

		<!-- –°–µ—Ç–∫–∞ -->
		<div id="gridOverlay" class="grid-overlay hidden"></div>

		<!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
		<div id="statusBar" class="connected">
			<div class="status-item">
				<span class="status-dot"></span>
				<div>
					<div class="status-label">Status</div>
					<div id="statusText">Connected</div>
				</div>
			</div>
			<div class="status-item">
				<div>
					<div class="status-label">Cooldown</div>
					<div id="cooldownTimer">Ready</div>
				</div>
			</div>
			<div class="status-item">
				<div>
					<div class="status-label">Online</div>
					<div id="onlineCount">0</div>
				</div>
			</div>
			<div class="status-item">
				<div>
					<div class="status-label">FPS</div>
					<div id="fpsCounter">60</div>
				</div>
			</div>
		</div>

		<!-- –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ -->
		<div id="colorPalette">
			<div class="palette-compact" id="paletteContainer">
				<!-- –¶–≤–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
			</div>
		</div>

		<!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
		<div id="navPanel">
			<div class="nav-item" id="navZoomOut" title="Zoom Out">
				<i>üîç‚àí</i>
				<span>Zoom Out</span>
			</div>
			<div class="nav-item" id="navZoomIn" title="Zoom In">
				<i>üîç+</i>
				<span>Zoom In</span>
			</div>
			<div class="nav-item" id="navCenter" title="Center View">
				<i>‚óé</i>
				<span>Center</span>
			</div>
			<div class="nav-item" id="navGrid" title="Toggle Grid">
				<i>#</i>
				<span>Grid</span>
			</div>
			<div class="nav-item" id="navMinimap" title="Toggle Minimap">
				<i>üó∫Ô∏è</i>
				<span>Map</span>
			</div>
		</div>

		<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑—É–º–µ -->
		<div id="zoomInfo">Zoom: <span id="zoomValue" class="zoom-value">100%</span></div>

		<!-- –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ -->
		<div id="minimap" class="hidden">
			<canvas id="minimapCanvas"></canvas>
			<div id="minimapViewport" class="minimap-viewport"></div>
		</div>

		<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
		<div id="coordIndicator">X: <span id="coordX">0</span>, Y: <span id="coordY">0</span></div>

		<!-- –ë—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
		<div id="quickTools">
			<div class="tool-btn" id="toolHand" title="Pan Tool (H)">‚úã</div>
			<div class="tool-btn active" id="toolPencil" title="Pencil Tool (P)">‚úèÔ∏è</div>
			<div class="tool-btn" id="toolPicker" title="Color Picker (C)">üé®</div>
			<div class="tool-btn" id="toolMagnifier" title="Magnifier Tool (M) - Toggle with M key">üîç</div>
		</div>

		<!-- –õ–æ–∞–¥–µ—Ä -->
		<div id="loader">
			<div class="spinner"></div>
			<div id="loaderTitle">Connecting to PixelBattle...</div>
			<div class="progress-bar">
				<div class="progress-fill" id="loaderProgress"></div>
			</div>
			<div id="loaderStatus" style="font-size: 12px; opacity: 0.8">Loading canvas data...</div>
		</div>

		<!-- –õ—É–ø–∞ -->
		<div id="magnifierContainer" class="hidden">
			<div id="magnifier">
				<canvas id="magnifierCanvas"></canvas>
				<div id="magnifierInfo">
					<div>Zoom: <span id="magnifierZoom">4x</span></div>
					<div>Color: <span id="magnifierColor">#000</span></div>
				</div>
			</div>
		</div>

		<script>
			const PIXEL_SIZE = 1; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∏–∫—Å–µ–ª—è

			class PixelBattleWallpaper {
				constructor() {
					this.canvasBuffer = null; // –ë—É—Ñ–µ—Ä –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
					this.bufferCtx = null;
					this.isRendering = false;
					this.dirtyRect = null; // –û–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
					this.loadedPixels = 0;
					this.totalPixels = 0;

					this.canvas = document.getElementById("mainCanvas");
					this.ctx = this.canvas.getContext("2d");
					this.ws = null;

					// –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –¥–æ–±–∞–≤–ª—è–µ–º:
					this.pendingBinaryData = null;
					this.expectingBinaryData = false;

					// –ë—É—Ñ–µ—Ä –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
					this.canvasBuffer = null;
					this.bufferCtx = null;

					// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
					this.canvasWidth = 800; // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
					this.canvasHeight = 800;
					this.cooldownTime = 1000; // 30 —Å–µ–∫—É–Ω–¥

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—ã
					this.camera = {
						x: 0,
						y: 0,
						zoom: 1.0,
						minZoom: 0.1,
						maxZoom: 20
					};

					// –õ—É–ø–∞
					this.magnifier = {
						enabled: false, // —Ç–æ–≥–ª –≤–∫–ª/–≤—ã–∫–ª
						zoomFactor: 4, // –º–Ω–æ–∂–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û —Ç–µ–∫—É—â–µ–≥–æ –∑—É–º–∞
						size: 200, // —Ä–∞–∑–º–µ—Ä –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–π –ª—É–ø—ã
						offsetX: 20, // —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
						offsetY: 20,
						canvas: null,
						ctx: null,
						canvasElement: null,
						showPixelGrid: true,
						showCrosshair: true
					};

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
					this.selectedColor = 0;
					this.activeTool = "pencil"; // pencil, hand, picker, fill
					this.isDragging = false;
					this.dragStart = { x: 0, y: 0 };
					this.showGrid = false;
					this.showMinimap = true;

					// –°–æ—Å—Ç–æ—è–Ω–∏–µ
					this.pixels = new Map();
					this.selectedColor = 0;
					this.activeTool = "pencil";
					this.isDragging = false;
					this.dragStart = { x: 0, y: 0 };
					this.isConnected = false;
					this.lastClickTime = 0;
					this.cooldownTime = 1000;

					// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
					this.lastFrameTime = 0;
					this.fps = 60;
					this.frameCount = 0;
					this.lastFpsUpdate = 0;

					// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
					this.serverConfig = {
						host: window.location.hostname || "localhost",
						port: 8080,
						secure: false,
						path: "/ws"
					};

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
					this.init();
				}

				init() {
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–æ–ª—Å—Ç–∞
					this.resizeCanvas();
					window.addEventListener("resize", () => this.resizeCanvas());

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
					this.initPalette();
					this.initMinimap();
					this.initEventListeners();
					this.initTools();

					// –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä
					this.updateLoader("Connecting to server...", 0);

					// –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
					this.connectToServer();

					this.initMagnifier();

					// –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
					this.animate();
				}

				initPalette() {
					const paletteContainer = document.getElementById("paletteContainer");
					const colors = this.getColorPalette();

					// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –ø–æ 8 –≤ —Ä—è–¥
					for (let i = 0; i < colors.length; i += 8) {
						const row = document.createElement("div");
						row.className = "color-row";

						for (let j = 0; j < 8; j++) {
							const index = i + j;
							if (index >= colors.length) break;

							const swatch = document.createElement("div");
							swatch.className = "color-swatch";
							if (index === this.selectedColor) {
								swatch.classList.add("selected");
							}
							swatch.style.backgroundColor = colors[index];
							swatch.dataset.index = index;

							swatch.addEventListener("click", e => {
								this.selectedColor = parseInt(e.target.dataset.index);
								document.querySelectorAll(".color-swatch").forEach(s => {
									s.classList.remove("selected");
								});
								e.target.classList.add("selected");
								this.activeTool = "pencil";
								this.updateTools();
							});

							row.appendChild(swatch);
						}
						paletteContainer.appendChild(row);
					}
				}

				initMagnifier() {
					this.magnifier.canvasElement = document.getElementById("magnifierCanvas");
					this.magnifier.canvas = document.createElement("canvas");
					this.magnifier.canvas.width = this.magnifier.size;
					this.magnifier.canvas.height = this.magnifier.size;
					this.magnifier.ctx = this.magnifier.canvas.getContext("2d");

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
					this.magnifier.ctx.imageSmoothingEnabled = false;

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è event listener –¥–ª—è –ª—É–ø—ã
					document.getElementById("toolMagnifier").addEventListener("click", () => {
						this.toggleMagnifier();
					});

					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ª—É–ø—É –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏
					this.canvas.addEventListener("mousemove", e => {
						if (this.magnifier.enabled) {
							this.updateMagnifierPosition(e);
						}
					});

					// –°–∫—Ä—ã–≤–∞–µ–º –ª—É–ø—É –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã canvas
					this.canvas.addEventListener("mouseleave", () => {
						this.hideMagnifier();
					});

					// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑—É–º–∞ –ª—É–ø—ã –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏ –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–º Alt
					this.canvas.addEventListener("wheel", e => {
						if (e.altKey && this.magnifier.enabled) {
							e.preventDefault();
							e.stopPropagation();

							const delta = e.deltaY > 0 ? 0.9 : 1.1;
							this.magnifier.zoomFactor = Math.max(2, Math.min(10, this.magnifier.zoomFactor * delta));

							// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
							const rect = this.canvas.getBoundingClientRect();
							const x = e.clientX - rect.left;
							const y = e.clientY - rect.top;
							this.updateMagnifierPosition({ clientX: e.clientX, clientY: e.clientY });

							this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
						}
					});
				}

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª—É–ø—ã (—Ç–æ–≥–ª)
				toggleMagnifier() {
					this.magnifier.enabled = !this.magnifier.enabled;

					const magnifierBtn = document.getElementById("toolMagnifier");
					if (this.magnifier.enabled) {
						magnifierBtn.classList.add("magnifier-active");
						document.getElementById("magnifierContainer").classList.remove("hidden");
						this.showNotification("Magnifier ON - Shows zoomed area for aiming", "info", 2000);
					} else {
						magnifierBtn.classList.remove("magnifier-active");
						document.getElementById("magnifierContainer").classList.add("hidden");
						this.showNotification("Magnifier OFF", "info", 1000);
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –ª—É–ø–∞ –≤–∫–ª—é—á–µ–Ω–∞
					if (this.magnifier.enabled) {
						this.render();
					}
				}

				updateMagnifier() {
					const magnifier = document.getElementById("magnifierContainer");
					if (this.activeTool === "magnifier") {
						magnifier.classList.remove("hidden");
						document.getElementById("magnifier").style.display = "block";
					} else {
						magnifier.classList.add("hidden");
						document.getElementById("magnifier").style.display = "none";
					}
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ª—É–ø—ã
				updateMagnifierPosition(e) {
					if (!this.magnifier.enabled || !this.bufferCtx) return;

					const magnifier = document.getElementById("magnifier");
					const mouseX = e.clientX;
					const mouseY = e.clientY;

					// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ª—É–ø—É —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä)
					const rect = this.canvas.getBoundingClientRect();
					const canvasX = mouseX - rect.left;
					const canvasY = mouseY - rect.top;

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –ª—É–ø—É, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω
					let posX = mouseX + this.magnifier.offsetX;
					let posY = mouseY + this.magnifier.offsetY;

					if (posX + this.magnifier.size > window.innerWidth) {
						posX = mouseX - this.magnifier.size - this.magnifier.offsetX;
					}
					if (posY + this.magnifier.size > window.innerHeight) {
						posY = mouseY - this.magnifier.size - this.magnifier.offsetY;
					}

					magnifier.style.left = posX + "px";
					magnifier.style.top = posY + "px";

					// –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª—É–ø—É
					this.renderMagnifier(canvasX, canvasY);
				}

				// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª—É–ø—ã
				renderMagnifier(canvasX, canvasY) {
					if (!this.bufferCtx || !this.canvasBuffer || !this.magnifier.enabled) return;

					// –ú–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
					const worldX = this.screenToWorldX(canvasX);
					const worldY = this.screenToWorldY(canvasY);

					// –û–ë–©–ò–ô –∑—É–º = –∑—É–º –∫–∞–º–µ—Ä—ã * –∑—É–º –ª—É–ø—ã
					const totalZoom = this.camera.zoom * this.magnifier.zoomFactor;

					// –†–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ –∑–∞—Ö–≤–∞—Ç–∞ (–≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
					const captureSize = this.magnifier.size / totalZoom;
					const halfSize = captureSize / 2;

					// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏ –∑–∞—Ö–≤–∞—Ç–∞
					const captureX = Math.max(0, Math.min(this.canvasWidth - captureSize, worldX - halfSize));
					const captureY = Math.max(0, Math.min(this.canvasHeight - captureSize, worldY - halfSize));

					// –û—á–∏—â–∞–µ–º canvas –ª—É–ø—ã
					this.magnifier.ctx.fillStyle = "#000";
					this.magnifier.ctx.fillRect(0, 0, this.magnifier.size, this.magnifier.size);

					// –ö–æ–ø–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ –ª—É–ø—É –ë–ï–ó –°–ì–õ–ê–ñ–ò–í–ê–ù–ò–Ø
					this.magnifier.ctx.save();
					this.magnifier.ctx.imageSmoothingEnabled = false;

					this.magnifier.ctx.drawImage(this.canvasBuffer, captureX, captureY, captureSize, captureSize, 0, 0, this.magnifier.size, this.magnifier.size);

					this.magnifier.ctx.restore();

					// –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –ø–∏–∫—Å–µ–ª–µ–π –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
					if (this.magnifier.showPixelGrid) {
						this.magnifier.ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
						this.magnifier.ctx.lineWidth = 1;
						const gridSize = totalZoom; // —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –ª—É–ø—ã

						for (let i = 0; i <= this.magnifier.size; i += gridSize) {
							this.magnifier.ctx.beginPath();
							this.magnifier.ctx.moveTo(i, 0);
							this.magnifier.ctx.lineTo(i, this.magnifier.size);
							this.magnifier.ctx.stroke();

							this.magnifier.ctx.beginPath();
							this.magnifier.ctx.moveTo(0, i);
							this.magnifier.ctx.lineTo(this.magnifier.size, i);
							this.magnifier.ctx.stroke();
						}
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º canvas –ª—É–ø—ã —Å –ø–∏–∫—Å–µ–ª—å–Ω—ã–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
					this.magnifier.canvasElement.width = this.magnifier.size;
					this.magnifier.canvasElement.height = this.magnifier.size;
					const displayCtx = this.magnifier.canvasElement.getContext("2d");

					// –í–´–ö–õ–Æ–ß–ê–ï–ú —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
					displayCtx.imageSmoothingEnabled = false;
					displayCtx.mozImageSmoothingEnabled = false;
					displayCtx.webkitImageSmoothingEnabled = false;
					displayCtx.msImageSmoothingEnabled = false;

					displayCtx.drawImage(this.magnifier.canvas, 0, 0);

					// –†–∏—Å—É–µ–º –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
					if (this.magnifier.showCrosshair) {
						const centerX = this.magnifier.size / 2;
						const centerY = this.magnifier.size / 2;

						displayCtx.strokeStyle = "#FF0000";
						displayCtx.lineWidth = 1;

						// –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
						displayCtx.beginPath();
						displayCtx.moveTo(centerX, 0);
						displayCtx.lineTo(centerX, this.magnifier.size);
						displayCtx.stroke();

						// –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
						displayCtx.beginPath();
						displayCtx.moveTo(0, centerY);
						displayCtx.lineTo(this.magnifier.size, centerY);
						displayCtx.stroke();

						// –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –ø–∏–∫—Å–µ–ª—è
						const pixelSize = totalZoom;
						displayCtx.strokeStyle = "#00FF00";
						displayCtx.lineWidth = 2;
						displayCtx.strokeRect(centerX - pixelSize / 2, centerY - pixelSize / 2, pixelSize, pixelSize);
					}

					// –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø–∏–∫—Å–µ–ª—è
					const centerWorldX = Math.floor(worldX);
					const centerWorldY = Math.floor(worldY);
					const pixelKey = `${centerWorldX},${centerWorldY}`;
					const colorIndex = this.pixels.get(pixelKey) || 0;
					const colors = this.getColorPalette();
					const colorHex = colors[colorIndex] || "#000000";

					// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
					const totalZoomPercent = Math.round(totalZoom * 100);
					document.getElementById("magnifierZoom").textContent = `${this.magnifier.zoomFactor}x (${totalZoomPercent}%)`;
					document.getElementById("magnifierColor").textContent = colorHex;
					document.getElementById("magnifierColor").style.color = colorHex;

					// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
					this.updateCoordinates(centerWorldX, centerWorldY);
				}
				hideMagnifier() {
					if (this.magnifier.enabled) {
						document.getElementById("magnifierContainer").classList.add("hidden");
					}
				}

				initMinimap() {
					this.minimapCanvas = document.getElementById("minimapCanvas");
					this.minimapCtx = this.minimapCanvas.getContext("2d");
					this.minimapCanvas.width = 150;
					this.minimapCanvas.height = 150;
				}

				initEventListeners() {
					// –ö–æ–ª—ë—Å–∏–∫–æ –º—ã—à–∏ - –∑—É–º
					this.canvas.addEventListener("wheel", e => {
						e.preventDefault();

						const rect = this.canvas.getBoundingClientRect();
						const mouseX = e.clientX - rect.left;
						const mouseY = e.clientY - rect.top;

						// –ú–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –¥–æ –∑—É–º–∞
						const worldX = this.screenToWorldX(mouseX);
						const worldY = this.screenToWorldY(mouseY);

						// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑—É–º–∞
						const delta = e.deltaY > 0 ? 0.9 : 1.1;
						const newZoom = Math.max(this.camera.minZoom, Math.min(this.camera.maxZoom, this.camera.zoom * delta));

						// –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–º–µ—Ä—ã —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –ø–æ–¥ –º—ã—à—å—é –æ—Å—Ç–∞–ª–∞—Å—å –Ω–∞ –º–µ—Å—Ç–µ
						this.camera.x = worldX - mouseX / newZoom;
						this.camera.y = worldY - mouseY / newZoom;
						this.camera.zoom = newZoom;

						this.clampCamera();
						this.updateZoomInfo();
						this.render();
					});

					// –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ - —Ä–∏—Å–æ–≤–∞–Ω–∏–µ/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
					this.canvas.addEventListener("mousedown", e => {
						const rect = this.canvas.getBoundingClientRect();
						this.dragStart = {
							x: e.clientX - rect.left,
							y: e.clientY - rect.top,
							cameraX: this.camera.x,
							cameraY: this.camera.y
						};

						if (e.button === 0) {
							// –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
							if (this.activeTool === "hand") {
								this.isDragging = true;
							} else if (this.activeTool === "pencil") {
								this.handleCanvasClick(e);
							} else if (this.activeTool === "picker") {
								this.handleColorPick(e);
							}
						} else if (e.button === 1) {
							// –°—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞
							this.isDragging = true;
							e.preventDefault();
						}
					});

					// –î–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏
					this.canvas.addEventListener("mousemove", e => {
						const rect = this.canvas.getBoundingClientRect();
						const mouseX = e.clientX - rect.left;
						const mouseY = e.clientY - rect.top;

						// –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
						const worldX = Math.floor(this.screenToWorldX(mouseX));
						const worldY = Math.floor(this.screenToWorldY(mouseY));
						this.updateCoordinates(worldX, worldY);

						// –û–±–Ω–æ–≤–ª—è–µ–º –ª—É–ø—É
						this.updateMagnifierPosition(e);

						// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
						if (this.isDragging) {
							const dx = (mouseX - this.dragStart.x) / (this.canvas.width / (this.canvasWidth / this.camera.zoom));
							const dy = (mouseY - this.dragStart.y) / (this.canvas.height / (this.canvasHeight / this.camera.zoom));

							this.camera.x = this.dragStart.cameraX - dx;
							this.camera.y = this.dragStart.cameraY - dy;

							// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ö–æ–ª—Å—Ç–∞
							this.clampCamera();
							this.render();
						}
					});

					// –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
					document.addEventListener("mouseup", () => {
						this.isDragging = false;
					});

					// –ö–ª–∞–≤–∏—à–∏
					document.addEventListener("keydown", e => {
						this.handleKeyDown(e);
					});

					// –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
					document.getElementById("navZoomIn").addEventListener("click", () => {
						this.camera.zoom = Math.min(this.camera.maxZoom, this.camera.zoom * 1.5);
						this.updateZoomInfo();
						this.render();
					});

					document.getElementById("navZoomOut").addEventListener("click", () => {
						this.camera.zoom = Math.max(this.camera.minZoom, this.camera.zoom / 1.5);
						this.updateZoomInfo();
						this.render();
					});

					document.getElementById("navCenter").addEventListener("click", () => {
						this.camera.x = this.canvasWidth / 2;
						this.camera.y = this.canvasHeight / 2;
						this.camera.zoom = 1.0;
						this.updateZoomInfo();
						this.render();
					});

					document.getElementById("navGrid").addEventListener("click", () => {
						this.showGrid = !this.showGrid;
						document.getElementById("gridOverlay").classList.toggle("hidden", !this.showGrid);
					});

					document.getElementById("navMinimap").addEventListener("click", () => {
						this.showMinimap = !this.showMinimap;
						document.getElementById("minimap").classList.toggle("hidden", !this.showMinimap);
					});

					// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º–∏–Ω–∏–∫–∞—Ä—Ç—ã
					const minimap = document.getElementById("minimap");
					minimap.addEventListener("mousedown", e => {
						const rect = minimap.getBoundingClientRect();
						const x = ((e.clientX - rect.left) / rect.width) * this.canvasWidth;
						const y = ((e.clientY - rect.top) / rect.height) * this.canvasHeight;

						this.camera.x = x;
						this.camera.y = y;
						this.clampCamera();
						this.render();
					});
				}

				initTools() {
					document.getElementById("toolPencil").addEventListener("click", () => {
						this.activeTool = "pencil";
						this.updateTools();
					});

					document.getElementById("toolHand").addEventListener("click", () => {
						this.activeTool = "hand";
						this.updateTools();
					});

					document.getElementById("toolPicker").addEventListener("click", () => {
						this.activeTool = "picker";
						this.updateTools();
					});
				}

				updateTools() {
					document.querySelectorAll(".tool-btn").forEach(btn => {
						btn.classList.remove("active");
						btn.classList.remove("magnifier-active");
					});

					switch (this.activeTool) {
						case "pencil":
							document.getElementById("toolPencil").classList.add("active");
							break;
						case "hand":
							document.getElementById("toolHand").classList.add("active");
							break;
						case "picker":
							document.getElementById("toolPicker").classList.add("active");
							break;
						case "fill":
							document.getElementById("toolFill").classList.add("active");
							break;
						case "magnifier":
							document.getElementById("toolMagnifier").classList.add("magnifier-active");
							break;
					}
				}

				getColorPalette() {
					return [
						"#000000",
						"#1A1A1A",
						"#333333",
						"#4D4D4D",
						"#666666",
						"#808080",
						"#999999",
						"#B3B3B3",
						"#CCCCCC",
						"#E6E6E6",
						"#FFFFFF",
						"#FF4444",
						"#FF8844",
						"#FFCC44",
						"#FFFF44",
						"#CCFF44",
						"#88FF44",
						"#44FF44",
						"#44FF88",
						"#44FFCC",
						"#44FFFF",
						"#44CCFF",
						"#4488FF",
						"#4444FF",
						"#8844FF",
						"#CC44FF",
						"#FF44FF",
						"#FF44CC",
						"#FF4488",
						"#FF4444",
						"#FF0000",
						"#00FF00",
						"#0000FF",
						"#FFFF00",
						"#FF00FF",
						"#00FFFF",
						"#FFA500",
						"#800080",
						"#008080",
						"#FFC0CB"
					];
				}

				resizeCanvas() {
					this.canvas.width = window.innerWidth;
					this.canvas.height = window.innerHeight;
					this.render();
				}

				// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –º–∏—Ä–æ–≤—ã–µ
				// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –º–∏—Ä–æ–≤—ã–µ
				screenToWorldX(screenX) {
					return Math.floor(this.camera.x + screenX / this.camera.zoom);
				}

				screenToWorldY(screenY) {
					return Math.floor(this.camera.y + screenY / this.camera.zoom);
				}

				// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ
				worldToScreenX(worldX) {
					return (worldX - this.camera.x) * this.camera.zoom;
				}

				worldToScreenY(worldY) {
					return (worldY - this.camera.y) * this.camera.zoom;
				}

				// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ö–æ–ª—Å—Ç–∞
				clampCamera() {
					const viewWidth = this.canvas.width / this.camera.zoom;
					const viewHeight = this.canvas.height / this.camera.zoom;

					// –ù–µ –¥–∞–µ–º –∫–∞–º–µ—Ä–µ –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ö–æ–ª—Å—Ç–∞
					this.camera.x = Math.max(0, Math.min(this.canvasWidth - viewWidth, this.camera.x));
					this.camera.y = Math.max(0, Math.min(this.canvasHeight - viewHeight, this.camera.y));
				}

				handleCanvasClick(e) {
					const now = Date.now();
					const timeSinceLastClick = now - this.lastClickTime;

					if (timeSinceLastClick < this.cooldownTime) {
						const secondsLeft = Math.ceil((this.cooldownTime - timeSinceLastClick) / 1000);
						this.showNotification(`Wait ${secondsLeft}s before placing next pixel`, "warning");
						return;
					}

					const rect = this.canvas.getBoundingClientRect();
					const screenX = e.clientX - rect.left;
					const screenY = e.clientY - rect.top;

					// –ü–†–ï–û–ë–†–ê–ó–£–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –ü–†–ê–í–ò–õ–¨–ù–û
					const worldX = this.screenToWorldX(screenX);
					const worldY = this.screenToWorldY(screenY);

					// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
					if (worldX < 0 || worldX >= this.canvasWidth || worldY < 0 || worldY >= this.canvasHeight) {
						this.showNotification(`Coordinates out of bounds (0-${this.canvasWidth - 1}, 0-${this.canvasHeight - 1})`, "warning");
						return;
					}

					// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
					if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
						this.ws.send(
							JSON.stringify({
								type: "placePixel",
								x: worldX,
								y: worldY,
								color: this.selectedColor,
								timestamp: now
							})
						);

						this.lastClickTime = now;
						this.updateCooldownTimer();

						// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
						this.setPixel(worldX, worldY, this.selectedColor);
						this.showNotification(`Placed pixel at (${worldX}, ${worldY})`);
					}
				}

				handleColorPick(e) {
					e.preventDefault();

					const rect = this.canvas.getBoundingClientRect();
					const screenX = e.clientX - rect.left;
					const screenY = e.clientY - rect.top;

					const worldX = Math.floor(this.screenToWorldX(screenX));
					const worldY = Math.floor(this.screenToWorldY(screenY));

					if (worldX >= 0 && worldX < this.canvasWidth && worldY >= 0 && worldY < this.canvasHeight) {
						const pixelKey = `${worldX},${worldY}`;
						const colorIndex = this.pixels.get(pixelKey) || 0;
						const colors = this.getColorPalette();

						this.selectedColor = colorIndex;

						// –û–±–Ω–æ–≤–ª—è–µ–º UI
						document.querySelectorAll(".color-swatch").forEach(s => {
							s.classList.remove("selected");
							if (parseInt(s.dataset.index) === colorIndex) {
								s.classList.add("selected");
							}
						});

						this.showNotification(`Picked color #${colorIndex}`, "info");
					}
				}

				handleKeyDown(e) {
					const speed = 100 / this.camera.zoom;

					switch (e.key.toLowerCase()) {
						case "arrowup":
							this.camera.y -= speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowdown":
							this.camera.y += speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowleft":
							this.camera.x -= speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "arrowright":
							this.camera.x += speed;
							this.clampCamera();
							this.render();
							e.preventDefault();
							break;

						case "+":
						case "=":
							this.camera.zoom = Math.min(this.camera.maxZoom, this.camera.zoom * 1.2);
							this.updateZoomInfo();
							this.render();
							e.preventDefault();
							break;

						case "-":
							this.camera.zoom = Math.max(this.camera.minZoom, this.camera.zoom / 1.2);
							this.updateZoomInfo();
							this.render();
							e.preventDefault();
							break;

						case "0":
							this.camera.x = this.canvasWidth / 2;
							this.camera.y = this.canvasHeight / 2;
							this.camera.zoom = 1.0;
							this.updateZoomInfo();
							this.render();
							break;

						case "h":
							this.activeTool = "hand";
							this.updateTools();
							break;

						case "p":
							this.activeTool = "pencil";
							this.updateTools();
							break;

						case "c":
							this.activeTool = "picker";
							this.updateTools();
							break;

						case "f":
							this.activeTool = "fill";
							this.updateTools();
							break;

						case "g":
							this.showGrid = !this.showGrid;
							document.getElementById("gridOverlay").classList.toggle("hidden", !this.showGrid);
							break;

						case "m":
							this.showMinimap = !this.showMinimap;
							document.getElementById("minimap").classList.toggle("hidden", !this.showMinimap);
							break;

						case "m":
							this.toggleMagnifier();
							e.preventDefault();
							break;

						case "[":
							if (this.magnifier.enabled) {
								this.magnifier.zoomFactor = Math.max(2, this.magnifier.zoomFactor - 1);
								const rect = this.canvas.getBoundingClientRect();
								this.updateMagnifierPosition({
									clientX: rect.left + this.canvas.width / 2,
									clientY: rect.top + this.canvas.height / 2
								});
								this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
								e.preventDefault();
							}
							break;

						case "]":
							if (this.magnifier.enabled) {
								this.magnifier.zoomFactor = Math.min(10, this.magnifier.zoomFactor + 1);
								const rect = this.canvas.getBoundingClientRect();
								this.updateMagnifierPosition({
									clientX: rect.left + this.canvas.width / 2,
									clientY: rect.top + this.canvas.height / 2
								});
								this.showNotification(`Magnifier: ${this.magnifier.zoomFactor}x`, "info", 1000);
								e.preventDefault();
							}
							break;

						case "escape":
							// –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å Wallpaper Engine
							break;
					}
				}

				setPixel(x, y, color) {
					const key = `${x},${y}`;
					this.pixels.set(key, color);

					// –†–∏—Å—É–µ–º –≤ –±—É—Ñ–µ—Ä–µ
					if (this.bufferCtx) {
						const colors = this.getColorPalette();
						this.bufferCtx.fillStyle = colors[color] || colors[0];
						this.bufferCtx.fillRect(x, y, 1, 1);
					}

					// –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
					this.render();
				}

				drawPixel(x, y, colorIndex) {
					const colors = this.getColorPalette();
					const color = colors[colorIndex] || colors[0];

					// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ
					const screenX = this.worldToScreenX(x);
					const screenY = this.worldToScreenY(y);
					const pixelSize = Math.max(1, this.camera.zoom);

					this.ctx.fillStyle = color;
					this.ctx.fillRect(screenX, screenY, pixelSize, pixelSize);
				}

				initCanvasBuffer() {
					this.canvasBuffer = document.createElement("canvas");
					this.canvasBuffer.width = this.canvasWidth;
					this.canvasBuffer.height = this.canvasHeight;
					this.bufferCtx = this.canvasBuffer.getContext("2d");

					// –ó–∞–ª–∏–≤–∞–µ–º —á–µ—Ä–Ω—ã–º
					this.bufferCtx.fillStyle = "#000";
					this.bufferCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
					this.bufferCtx.imageSmoothingEnabled = false;
					this.ctx.imageSmoothingEnabled = false;
				}

				// –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é render:
				render() {
					if (!this.bufferCtx || !this.canvasBuffer) {
						// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞ –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤
						this.ctx.fillStyle = "#0a0a0a";
						this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
						return;
					}

					// –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
					this.ctx.fillStyle = "#0a0a0a";
					this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

					// –í—ã—á–∏—Å–ª—è–µ–º –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å –≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
					const visibleMinX = Math.max(0, Math.floor(this.camera.x));
					const visibleMaxX = Math.min(this.canvasWidth, Math.ceil(this.camera.x + this.canvas.width / this.camera.zoom));
					const visibleMinY = Math.max(0, Math.floor(this.camera.y));
					const visibleMaxY = Math.min(this.canvasHeight, Math.ceil(this.camera.y + this.canvas.height / this.camera.zoom));

					const bufferWidth = visibleMaxX - visibleMinX;
					const bufferHeight = visibleMaxY - visibleMinY;

					if (bufferWidth <= 0 || bufferHeight <= 0) return;

					// –í—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
					const tempCanvas = document.createElement("canvas");
					tempCanvas.width = bufferWidth;
					tempCanvas.height = bufferHeight;
					const tempCtx = tempCanvas.getContext("2d");

					// –í–´–ö–õ–Æ–ß–ê–ï–ú —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–∏
					tempCtx.imageSmoothingEnabled = false;
					tempCtx.mozImageSmoothingEnabled = false;
					tempCtx.webkitImageSmoothingEnabled = false;
					tempCtx.msImageSmoothingEnabled = false;

					// –ö–æ–ø–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞
					tempCtx.drawImage(this.canvasBuffer, visibleMinX, visibleMinY, bufferWidth, bufferHeight, 0, 0, bufferWidth, bufferHeight);

					// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
					const screenX = (visibleMinX - this.camera.x) * this.camera.zoom;
					const screenY = (visibleMinY - this.camera.y) * this.camera.zoom;
					const screenWidth = bufferWidth * this.camera.zoom;
					const screenHeight = bufferHeight * this.camera.zoom;

					// –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º canvas
					this.ctx.imageSmoothingEnabled = false;
					this.ctx.mozImageSmoothingEnabled = false;
					this.ctx.webkitImageSmoothingEnabled = false;
					this.ctx.msImageSmoothingEnabled = false;

					// –†–∏—Å—É–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
					this.ctx.drawImage(tempCanvas, 0, 0, bufferWidth, bufferHeight, screenX, screenY, screenWidth, screenHeight);

					// –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É
					this.updateMinimap();
				}

				updateMinimap() {
					if (!this.showMinimap || !this.minimapCtx || !this.bufferCtx) return;

					// –û—á–∏—â–∞–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É
					this.minimapCtx.fillStyle = "#1a1a1a";
					this.minimapCtx.fillRect(0, 0, 150, 150);

					// –ú–∞—Å—à—Ç–∞–± –¥–ª—è –º–∏–Ω–∏–∫–∞—Ä—Ç—ã
					const scaleX = 150 / this.canvasWidth;
					const scaleY = 150 / this.canvasHeight;
					const scale = Math.min(scaleX, scaleY);

					// –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±—É—Ñ–µ—Ä–∞
					this.minimapCtx.drawImage(this.canvasBuffer, 0, 0, this.canvasWidth, this.canvasHeight, 0, 0, this.canvasWidth * scale, this.canvasHeight * scale);

					// –†–∏—Å—É–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
					const viewX = this.camera.x * scale;
					const viewY = this.camera.y * scale;
					const viewWidth = (this.canvas.width / this.camera.zoom) * scale;
					const viewHeight = (this.canvas.height / this.camera.zoom) * scale;

					const viewport = document.getElementById("minimapViewport");
					viewport.style.left = `${viewX}px`;
					viewport.style.top = `${viewY}px`;
					viewport.style.width = `${viewWidth}px`;
					viewport.style.height = `${viewHeight}px`;
				}

				updateCoordinates(x, y) {
					document.getElementById("coordX").textContent = x;
					document.getElementById("coordY").textContent = y;
				}

				updateZoomInfo() {
					const zoomPercent = Math.round(this.camera.zoom * 100);
					document.getElementById("zoomValue").textContent = `${zoomPercent}%`;
				}

				updateCooldownTimer() {
					const timerElement = document.getElementById("cooldownTimer");
					const updateTimer = () => {
						const now = Date.now();
						const timeLeft = Math.max(0, this.cooldownTime - (now - this.lastClickTime));

						if (timeLeft <= 0) {
							timerElement.textContent = "Ready";
							timerElement.style.color = "#4CAF50";
						} else {
							const seconds = Math.ceil(timeLeft / 1000);
							timerElement.textContent = `${seconds}s`;
							timerElement.style.color = seconds <= 5 ? "#4CAF50" : "#FF9800";
						}
					};

					updateTimer();
					if (this.cooldownInterval) clearInterval(this.cooldownInterval);
					this.cooldownInterval = setInterval(updateTimer, 1000);
				}

				updateFPS() {
					const now = performance.now();
					this.frameCount++;

					if (now - this.lastFpsUpdate >= 1000) {
						this.fps = Math.round((this.frameCount * 1000) / (now - this.lastFpsUpdate));
						this.frameCount = 0;
						this.lastFpsUpdate = now;

						document.getElementById("fpsCounter").textContent = this.fps;
					}
				}

				updateLoader(title, progress) {
					document.getElementById("loaderTitle").textContent = title;
					document.getElementById("loaderProgress").style.width = `${progress}%`;
				}

				connectToServer() {
					const wsUrl = `ws://${this.serverConfig.host}:${this.serverConfig.port}${this.serverConfig.path}`;
					this.updateStatus("connecting", "Connecting...");

					try {
						this.ws = new WebSocket(wsUrl);

						// –†–∞–∑—Ä–µ—à–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						this.ws.binaryType = "arraybuffer";

						this.ws.onopen = () => {
							this.isConnected = true;
							this.updateStatus("connected", "Connected");
							this.updateLoader("Requesting canvas...", 10);
							this.ws.send(JSON.stringify({ type: "getCanvas" }));
						};

						// –û–±–Ω–æ–≤–ª—è–µ–º ws.onmessage:
						this.ws.onmessage = event => {
							console.log("üì• Received message:", event.data instanceof ArrayBuffer ? "Binary" : "Text", event.data instanceof ArrayBuffer ? event.data.byteLength : event.data.length);

							// –ï—Å–ª–∏ —ç—Ç–æ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
							if (event.data instanceof ArrayBuffer) {
								if (this.expectingBinaryData) {
									this.processBinaryChunk(event.data);
									this.expectingBinaryData = false;
								} else {
									console.warn("‚ö†Ô∏è Unexpected binary data received");
									// –ü—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —á–∞–Ω–∫
									this.processBinaryChunk(event.data);
								}
							}
							// –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)
							else {
								try {
									const data = JSON.parse(event.data);
									console.log("üì• Parsed JSON:", data.type, data);
									this.handleServerMessage(data);
								} catch (error) {
									console.error("‚ùå Error parsing message:", error, "Data:", event.data);
								}
							}
						};

						this.ws.onclose = () => {
							this.isConnected = false;
							this.updateStatus("disconnected", "Disconnected");
							this.showNotification("Disconnected from server", "error");
						};

						this.ws.onerror = error => {
							console.error("WebSocket error:", error);
							this.updateStatus("disconnected", "Connection error");
							this.updateLoader("Connection failed. Running in offline mode.", 100);
							setTimeout(() => {
								document.getElementById("loader").classList.add("hidden");
							}, 2000);
						};
					} catch (error) {
						console.error("Failed to create WebSocket:", error);
						this.updateStatus("disconnected", "Connection failed");
					}
				}

				handleServerMessage(data) {
					switch (data.type) {
						case "welcome":
							// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
							this.canvasWidth = data.canvas.width || 800;
							this.canvasHeight = data.canvas.height || 800;
							this.cooldownTime = data.cooldown || 1000;
							this.usersOnline = data.online || 0;

							// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
							this.initCanvasBuffer();

							// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
							this.camera.x = this.canvasWidth / 2 - this.canvas.width / this.camera.zoom / 2;
							this.camera.y = this.canvasHeight / 2 - this.canvas.height / this.camera.zoom / 2;
							this.clampCamera();

							// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç
							this.ws.send(JSON.stringify({ type: "getCanvas" }));
							break;
						case "canvasInfo":
							this.canvasWidth = data.width || 800;
							this.canvasHeight = data.height || 800;
							this.totalChunks = data.totalChunks || 1;
							this.loadedChunks = new Set();

							// –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
							this.initCanvasBuffer();
							break;
						case "chunkMeta":
							this.handleChunkMeta(data);
							break;
						case "canvasComplete":
							this.handleCanvasComplete();
							break;
						case "pixelUpdate":
							this.handlePixelUpdate(data);
							break;
						case "onlineCount":
							this.usersOnline = data.count;
							document.getElementById("onlineCount").textContent = data.count;
							break;
						case "welcome":
							this.canvasWidth = data.canvas.width || 8192;
							this.canvasHeight = data.canvas.height || 8192;
							this.cooldownTime = data.cooldown || 1000;
							this.usersOnline = data.online || 0;
							document.getElementById("onlineCount").textContent = this.usersOnline;
							break;
						case "canvasChunk":
							this.loadCanvasChunk(data);
							break;
						case "pixelPlaced":
							this.lastClickTime = data.timestamp;
							this.updateCooldownTimer();
							break;

						case "cooldown":
							const seconds = Math.ceil(data.timeLeft / 1000);
							this.showNotification(`Cooldown: ${seconds}s remaining`, "warning");
							break;

						case "error":
							this.showNotification(data.message, "error");
							break;
					}
				}

				// –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
				handleCanvasInfo(info) {
					console.log("üé® Canvas info received:", info);

					this.canvasWidth = info.width;
					this.canvasHeight = info.height;
					this.totalChunks = info.totalChunks;
					this.chunkSize = info.chunkSize;
					this.totalPixels = info.totalPixels || info.width * info.height;

					console.log(`üé® Canvas: ${this.canvasWidth}x${this.canvasHeight}, ${this.totalPixels} pixels, ${this.totalChunks} chunks`);

					this.updateLoader(`Canvas: ${info.width}x${info.height}`, 5);

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
					if (!this.canvasBuffer) {
						this.canvasBuffer = document.createElement("canvas");
						this.canvasBuffer.width = this.canvasWidth;
						this.canvasBuffer.height = this.canvasHeight;
						this.bufferCtx = this.canvasBuffer.getContext("2d");

						// –ó–∞–ª–∏–≤–∞–µ–º —á–µ—Ä–Ω—ã–º
						this.bufferCtx.fillStyle = "#000";
						this.bufferCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
					}
				}

				handleChunkMeta(meta) {
					console.log("üì¶ Chunk metadata:", meta);

					this.lastChunkStart = meta.start;
					this.currentChunkIndex = meta.chunkIndex;
					this.currentChunkSize = meta.size || meta.end - meta.start;

					// –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞–Ω–∫–∞
					this.expectingBinaryData = true;

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					const progress = Math.min(100, Math.round(((meta.chunkIndex + 1) / this.totalChunks) * 95));

					this.updateLoader(`Loading chunk ${meta.chunkIndex + 1}/${this.totalChunks} (${progress}%)`, progress);
				}

				loadCanvasChunk(data) {
					// –î–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
					if (data instanceof ArrayBuffer) {
						this.processBinaryChunk(data);
					} else if (typeof data === "string") {
						// JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
						try {
							const message = JSON.parse(data);
							this.handleChunkMetadata(message);
						} catch (e) {
							console.error("Error parsing message:", e);
						}
					}
				}

				// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è processBinaryChunk:
				processBinaryChunk(binaryData) {
					if (!this.bufferCtx) return;

					const uint8Array = new Uint8Array(binaryData);
					const colors = this.getColorPalette();

					for (let i = 0; i < uint8Array.length; i++) {
						const globalIndex = this.lastChunkStart + i;
						const x = globalIndex % this.canvasWidth;
						const y = Math.floor(globalIndex / this.canvasWidth);
						const color = uint8Array[i];

						if (color !== 0) {
							this.pixels.set(`${x},${y}`, color);
							this.bufferCtx.fillStyle = colors[color] || colors[0];
							this.bufferCtx.fillRect(x, y, 1, 1);
						}
					}

					this.loadedChunkCount++;

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					if (this.totalChunks > 0) {
						const progress = Math.min(95, Math.round((this.loadedChunkCount / this.totalChunks) * 95));
						this.updateLoader(`Loading... ${progress}%`, progress);
					}

					// –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–µ 5 —á–∞–Ω–∫–æ–≤
					if (this.loadedChunkCount % 5 === 0) {
						this.render();
					}
				}

				handleChunkMetadata(meta) {
					switch (meta.type) {
						case "canvasInfo":
							this.canvasWidth = meta.width;
							this.canvasHeight = meta.height;
							this.totalChunks = meta.totalChunks;
							this.chunkSize = meta.chunkSize;
							this.totalPixels = meta.width * meta.height;
							this.updateLoader("Starting canvas load...", 5);

							console.log("Received chunk size:", meta);
							break;

						case "chunkMeta":
							this.lastChunkStart = meta.start;
							break;

						case "canvasComplete":
							this.handleCanvasComplete();
							break;
					}
				}

				// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
				scheduleRender() {
					if (!this.isRendering) {
						this.isRendering = true;
						requestAnimationFrame(() => {
							this.render();
							this.isRendering = false;
						});
					}
				}

				handleCanvasComplete() {
					console.log("‚úÖ Canvas loading complete!");

					// –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
					this.render();

					// –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
					this.updateLoader("Canvas loaded!", 100);
					setTimeout(() => {
						document.getElementById("loader").classList.add("hidden");
						this.showNotification(`Canvas loaded: ${this.canvasWidth}x${this.canvasHeight}`, "info");
					}, 500);

					// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
					this.camera.x = this.canvasWidth / 2 - this.canvas.width / this.camera.zoom / 2;
					this.camera.y = this.canvasHeight / 2 - this.canvas.height / this.camera.zoom / 2;
					this.clampCamera();
					this.updateZoomInfo();
					this.render();
				}

				handlePixelUpdate(data) {
					const { x, y, color } = data;
					this.setPixel(x, y, color);
					this.render();
				}

				updateStatus(status, text) {
					const statusBar = document.getElementById("statusBar");
					const statusText = document.getElementById("statusText");
					statusBar.className = status;
					statusText.textContent = text;
				}

				showNotification(message, type = "info") {
					const oldNotifications = document.querySelectorAll(".notification");
					oldNotifications.forEach(n => n.remove());

					const notification = document.createElement("div");
					notification.className = `notification ${type}`;
					notification.textContent = message;
					document.body.appendChild(notification);

					setTimeout(() => notification.remove(), 3000);
				}

				animate() {
					requestAnimationFrame(() => this.animate());
				}
			}

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
			window.addEventListener("load", () => {
				window.pixelWall = new PixelBattleWallpaper();
			});
		</script>
	</body>
</html>
